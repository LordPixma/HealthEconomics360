<!-- app/templates/pricing/index.html - Price overview page -->
{% extends 'base.html' %}

{% block title %}Price Overview | HealthEconomics360{% endblock %}

{% block content %}
<div class="container-fluid pt-3">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="fas fa-tags me-2"></i> Price Overview</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="export-csv">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="export-pdf">
                    <i class="fas fa-file-pdf"></i> Export PDF
                </button>
            </div>
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addPriceModal">
                <i class="fas fa-plus"></i> Add Price Data
            </button>
        </div>
    </div>
    
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Drugs Tracked</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalDrugsCount">{{ drugs|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-pills fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Regions Covered</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="regionsCount">{{ regions|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-globe fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Average Price Disparity</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="avgDisparity">--</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-percentage fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Price Data Points</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="dataPointsCount">--</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-database fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Price Data Filters -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-filter me-2"></i> Filter Price Data</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="drugFilter" class="form-label">Drug</label>
                    <select class="form-select" id="drugFilter">
                        <option value="">All Drugs</option>
                        {% for drug in drugs %}
                            <option value="{{ drug.id }}">{{ drug.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="regionFilter" class="form-label">Region</label>
                    <select class="form-select" id="regionFilter">
                        <option value="">All Regions</option>
                        {% for region in regions %}
                            <option value="{{ region.id }}">{{ region.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="dateRangeFilter" class="form-label">Date Range</label>
                    <select class="form-select" id="dateRangeFilter">
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="180">Last 6 Months</option>
                        <option value="365">Last Year</option>
                        <option value="all" selected>All Time</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="priceTypeFilter" class="form-label">Price Type</label>
                    <select class="form-select" id="priceTypeFilter">
                        <option value="">All Price Types</option>
                        <option value="retail">Retail</option>
                        <option value="wholesale">Wholesale</option>
                        <option value="negotiated">Negotiated</option>
                        <option value="list">List</option>
                    </select>
                </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
                <button type="button" class="btn btn-primary" id="applyFilters">
                    <i class="fas fa-search me-2"></i> Apply Filters
                </button>
                <button type="button" class="btn btn-secondary ms-2" id="resetFilters">
                    <i class="fas fa-undo me-2"></i> Reset
                </button>
            </div>
        </div>
    </div>
    
    <!-- Price Comparison Chart -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Price Comparison by Region</h5>
        </div>
        <div class="card-body">
            <div id="chartContainer" style="height: 400px;">
                <canvas id="priceComparisonChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Price Data Table -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-table me-2"></i> Price Data</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="priceDataTable">
                    <thead>
                        <tr>
                            <th>Drug</th>
                            <th>Region</th>
                            <th>Price (USD)</th>
                            <th>Price Type</th>
                            <th>Date</th>
                            <th>Disparity*</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="priceTableBody">
                        <!-- Table data will be loaded dynamically -->
                        <tr>
                            <td colspan="7" class="text-center">Loading price data...</td>
                        </tr>
                    </tbody>
                </table>
                <p class="small text-muted mt-2">* Disparity shows percentage difference from global average price</p>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="dataTables_info" id="dataTableInfo">Showing 0 to 0 of 0 entries</div>
                <div class="dataTables_paginate">
                    <ul class="pagination" id="tablePagination">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">Previous</a>
                        </li>
                        <li class="page-item active">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Price Trend Analysis -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Price Trend Analysis</h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="trendDrugSelect" class="form-label">Select Drug</label>
                    <select class="form-select" id="trendDrugSelect">
                        <option value="">Choose a drug...</option>
                        {% for drug in drugs %}
                            <option value="{{ drug.id }}">{{ drug.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-8">
                    <label class="form-label">Time Period</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="timeperiod" id="tp1" value="30" autocomplete="off">
                        <label class="btn btn-outline-primary" for="tp1">30 Days</label>

                        <input type="radio" class="btn-check" name="timeperiod" id="tp2" value="90" autocomplete="off">
                        <label class="btn btn-outline-primary" for="tp2">90 Days</label>

                        <input type="radio" class="btn-check" name="timeperiod" id="tp3" value="180" autocomplete="off">
                        <label class="btn btn-outline-primary" for="tp3">6 Months</label>

                        <input type="radio" class="btn-check" name="timeperiod" id="tp4" value="365" autocomplete="off">
                        <label class="btn btn-outline-primary" for="tp4">1 Year</label>

                        <input type="radio" class="btn-check" name="timeperiod" id="tp5" value="all" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="tp5">All Time</label>
                    </div>
                </div>
            </div>
            <div id="trendChartContainer" style="height: 400px;">
                <canvas id="priceTrendChart"></canvas>
            </div>
            <div id="trendNoDataMessage" class="alert alert-info text-center mt-3 d-none">
                <i class="fas fa-info-circle me-2"></i> Select a drug to view price trends
            </div>
        </div>
    </div>
</div>

<!-- Add Price Modal -->
<div class="modal fade" id="addPriceModal" tabindex="-1" aria-labelledby="addPriceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPriceModalLabel">Add New Price Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPriceForm" action="{{ url_for('pricing.add_price') }}" method="POST">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="drug_id" class="form-label">Drug</label>
                            <select class="form-select" id="drug_id" name="drug_id" required>
                                <option value="">Select a drug...</option>
                                {% for drug in drugs %}
                                    <option value="{{ drug.id }}">{{ drug.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="region_id" class="form-label">Region</label>
                            <select class="form-select" id="region_id" name="region_id" required>
                                <option value="">Select a region...</option>
                                {% for region in regions %}
                                    <option value="{{ region.id }}">{{ region.name }}, {{ region.country }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="price" class="form-label">Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="currency" class="form-label">Currency</label>
                            <select class="form-select" id="currency" name="currency">
                                <option value="USD" selected>USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="CAD">CAD - Canadian Dollar</option>
                                <option value="AUD">AUD - Australian Dollar</option>
                                <option value="JPY">JPY - Japanese Yen</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="price_date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="price_date" name="price_date" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="price_type" class="form-label">Price Type</label>
                            <select class="form-select" id="price_type" name="price_type">
                                <option value="retail" selected>Retail</option>
                                <option value="wholesale">Wholesale</option>
                                <option value="negotiated">Negotiated</option>
                                <option value="list">List</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="source" class="form-label">Source</label>
                            <input type="text" class="form-control" id="source" name="source" placeholder="e.g., Website, Report, Survey">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addPriceForm" class="btn btn-primary">Save Price Data</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set default date for the price date input
        document.getElementById('price_date').valueAsDate = new Date();
        
        // Initialize variables
        let priceData = [];
        let priceComparisonChart, priceTrendChart;
        
        // Load price data from API
        loadPriceData();
        
        // Event listeners
        document.getElementById('applyFilters').addEventListener('click', function() {
            loadPriceData();
        });
        
        document.getElementById('resetFilters').addEventListener('click', function() {
            document.getElementById('drugFilter').value = '';
            document.getElementById('regionFilter').value = '';
            document.getElementById('dateRangeFilter').value = 'all';
            document.getElementById('priceTypeFilter').value = '';
            loadPriceData();
        });
        
        document.getElementById('trendDrugSelect').addEventListener('change', function() {
            const drugId = this.value;
            if (drugId) {
                const timePeriod = document.querySelector('input[name="timeperiod"]:checked').value;
                loadPriceTrendData(drugId, timePeriod);
                document.getElementById('trendNoDataMessage').classList.add('d-none');
            } else {
                document.getElementById('trendNoDataMessage').classList.remove('d-none');
                if (priceTrendChart) {
                    priceTrendChart.destroy();
                    priceTrendChart = null;
                }
            }
        });
        
        document.querySelectorAll('input[name="timeperiod"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                const drugId = document.getElementById('trendDrugSelect').value;
                if (drugId) {
                    loadPriceTrendData(drugId, this.value);
                }
            });
        });
        
        // Load price data function
        function loadPriceData() {
            const drugId = document.getElementById('drugFilter').value;
            const regionId = document.getElementById('regionFilter').value;
            const dateRange = document.getElementById('dateRangeFilter').value;
            const priceType = document.getElementById('priceTypeFilter').value;
            
            // Build query parameters
            let params = new URLSearchParams();
            if (drugId) params.append('drug_id', drugId);
            if (regionId) params.append('region_id', regionId);
            if (dateRange && dateRange !== 'all') params.append('days', dateRange);
            if (priceType) params.append('price_type', priceType);
            
            // Show loading state
            document.getElementById('priceTableBody').innerHTML = '<tr><td colspan="7" class="text-center">Loading price data...</td></tr>';
            
            // Fetch data from API
            fetch(`/pricing/price-data?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    priceData = data;
                    updatePriceTable(priceData);
                    updateSummaryMetrics(priceData);
                    updatePriceComparisonChart(priceData);
                })
                .catch(error => {
                    console.error('Error loading price data:', error);
                    document.getElementById('priceTableBody').innerHTML = 
                        '<tr><td colspan="7" class="text-center text-danger">Error loading data. Please try again.</td></tr>';
                });
        }
        
        // Update price table
        function updatePriceTable(data) {
            const tableBody = document.getElementById('priceTableBody');
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No price data found for the selected filters.</td></tr>';
                document.getElementById('dataTableInfo').textContent = 'Showing 0 to 0 of 0 entries';
                return;
            }
            
            // Calculate global average price for each drug
            const drugAvgPrices = {};
            data.forEach(item => {
                if (!drugAvgPrices[item.drug]) {
                    drugAvgPrices[item.drug] = {
                        total: 0,
                        count: 0
                    };
                }
                drugAvgPrices[item.drug].total += item.price;
                drugAvgPrices[item.drug].count++;
            });
            
            Object.keys(drugAvgPrices).forEach(drug => {
                drugAvgPrices[drug] = drugAvgPrices[drug].total / drugAvgPrices[drug].count;
            });
            
            // Generate table rows
            let html = '';
            data.forEach(item => {
                const avgPrice = drugAvgPrices[item.drug];
                const disparity = ((item.price - avgPrice) / avgPrice * 100).toFixed(1);
                const disparityClass = disparity > 10 ? 'text-danger' : 
                                      disparity < -10 ? 'text-success' : 'text-muted';
                
                html += `
                <tr>
                    <td>${item.drug}</td>
                    <td>${item.region}</td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td><span class="badge bg-secondary">${item.type || 'N/A'}</span></td>
                    <td>${item.date}</td>
                    <td class="${disparityClass}">${disparity}%</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-1" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            document.getElementById('dataTableInfo').textContent = `Showing 1 to ${data.length} of ${data.length} entries`;
        }
        
        // Update summary metrics
        function updateSummaryMetrics(data) {
            // Update data points count
            document.getElementById('dataPointsCount').textContent = data.length;
            
            // Calculate average price disparity
            const drugPrices = {};
            
            data.forEach(item => {
                if (!drugPrices[item.drug]) {
                    drugPrices[item.drug] = {
                        prices: [],
                        min: Infinity,
                        max: -Infinity
                    };
                }
                
                drugPrices[item.drug].prices.push(item.price);
                drugPrices[item.drug].min = Math.min(drugPrices[item.drug].min, item.price);
                drugPrices[item.drug].max = Math.max(drugPrices[item.drug].max, item.price);
            });
            
            let totalDisparity = 0;
            let count = 0;
            
            for (const drug in drugPrices) {
                if (drugPrices[drug].min > 0 && drugPrices[drug].prices.length > 1) {
                    const disparity = (drugPrices[drug].max - drugPrices[drug].min) / drugPrices[drug].min * 100;
                    totalDisparity += disparity;
                    count++;
                }
            }
            
            const avgDisparity = count > 0 ? (totalDisparity / count).toFixed(1) : 0;
            document.getElementById('avgDisparity').textContent = `${avgDisparity}%`;
        }
        
        // Update price comparison chart
        function updatePriceComparisonChart(data) {
            const ctx = document.getElementById('priceComparisonChart').getContext('2d');
            
            // Group data by drug and region
            const drugSet = new Set();
            const regionSet = new Set();
            const pricesByDrugAndRegion = {};
            
            data.forEach(item => {
                drugSet.add(item.drug);
                regionSet.add(item.region);
                
                const key = `${item.drug}|${item.region}`;
                if (!pricesByDrugAndRegion[key]) {
                    pricesByDrugAndRegion[key] = [];
                }
                
                pricesByDrugAndRegion[key].push(item.price);
            });
            
            // Calculate average price for each drug-region pair
            const chartData = [];
            for (const key in pricesByDrugAndRegion) {
                const [drug, region] = key.split('|');
                const prices = pricesByDrugAndRegion[key];
                const avgPrice = prices.reduce((sum, price) => sum + price, 0) / prices.length;
                
                chartData.push({
                    drug,
                    region,
                    price: avgPrice
                });
            }
            
            // Convert to chart.js format
            const drugs = Array.from(drugSet);
            const regions = Array.from(regionSet);
            
            const datasets = regions.map((region, index) => {
                const color = getChartColor(index);
                
                return {
                    label: region,
                    backgroundColor: color,
                    borderColor: color.replace('0.7', '1'),
                    data: drugs.map(drug => {
                        const entry = chartData.find(item => item.drug === drug && item.region === region);
                        return entry ? entry.price : null;
                    })
                };
            });
            
            // Destroy existing chart if it exists
            if (priceComparisonChart) {
                priceComparisonChart.destroy();
            }
            
            // Create new chart
            priceComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: drugs,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Drugs'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Price (USD)'
                            }
                        }
                    }
                }
            });
        }
        
        // Load price trend data
        function loadPriceTrendData(drugId, timePeriod) {
            // Build query parameters
            let params = new URLSearchParams();
            params.append('drug_id', drugId);
            if (timePeriod && timePeriod !== 'all') {
                params.append('days', timePeriod);
            }
            
            // Fetch data from API
            fetch(`/pricing/price-data?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    updatePriceTrendChart(data);
                })
                .catch(error => {
                    console.error('Error loading price trend data:', error);
                });
        }
        
        // Update price trend chart
        function updatePriceTrendChart(data) {
            const ctx = document.getElementById('priceTrendChart').getContext('2d');
            
            // Group data by region and sort by date
            const regionData = {};
            
            data.forEach(item => {
                if (!regionData[item.region]) {
                    regionData[item.region] = [];
                }
                
                regionData[item.region].push({
                    date: new Date(item.date),
                    price: item.price
                });
            });
            
            // Sort data by date for each region
            for (const region in regionData) {
                regionData[region].sort((a, b) => a.date - b.date);
            }
            
            // Convert to chart.js format
            const datasets = [];
            let index = 0;
            
            for (const region in regionData) {
                const color = getChartColor(index);
                const points = regionData[region];
                
                datasets.push({
                    label: region,
                    backgroundColor: color.replace('0.7', '0.1'),
                    borderColor: color.replace('0.7', '1'),
                    pointBackgroundColor: color,
                    pointBorderColor: '#fff',
                    pointRadius: 4,
                    tension: 0.3,
                    fill: true,
                    data: points.map(point => ({
                        x: point.date,
                        y: point.price
                    }))
                });
                
                index++;
            }
            
            // Destroy existing chart if it exists
            if (priceTrendChart) {
                priceTrendChart.destroy();
            }
            
            // Create new chart
            priceTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.raw.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'MMM YYYY'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Price (USD)'
                            }
                        }
                    }
                }
            });
        }
        
        // Helper function to get chart colors
        function getChartColor(index) {
            const colors = [
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(201, 203, 207, 0.7)',
                'rgba(0, 162, 151, 0.7)',
                'rgba(142, 36, 170, 0.7)',
                'rgba(211, 47, 47, 0.7)'
            ];
            
            return colors[index % colors.length];
        }
        
        // Export functions
        document.getElementById('export-csv').addEventListener('click', function() {
            exportTableToCSV('price_data.csv');
        });
        
        document.getElementById('export-pdf').addEventListener('click', function() {
            alert('PDF export functionality will be implemented in a future update.');
        });
        
        function exportTableToCSV(filename) {
            let csv = [];
            const rows = document.querySelectorAll('#priceDataTable tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll('td, th');
                
                for (let j = 0; j < cols.length; j++) {
                    // Skip the actions column
                    if (i === 0 && j === 6) continue;
                    if (i > 0 && j === 6) continue;
                    
                    // Get the text content and clean it
                    let data = cols[j].textContent.trim();
                    data = data.replace(/(\r\n|\n|\r)/gm, ' ').replace(/(\s\s)/gm, ' ');
                    data = data.replace(/"/g, '""');
                    
                    row.push('"' + data + '"');
                }
                
                csv.push(row.join(','));
            }
            
            // Download CSV file
            downloadCSV(csv.join('\n'), filename);
        }
        
        function downloadCSV(csv, filename) {
            const csvFile = new Blob([csv], {type: 'text/csv'});
            const downloadLink = document.createElement('a');
            
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
    });
</script>
{% endblock %}