<!-- app/templates/analytics/waste_analysis.html - Waste analysis page -->
{% extends 'base.html' %}

{% block title %}Waste Analysis | HealthEconomics360{% endblock %}

{% block content %}
<div class="container-fluid pt-3">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="fas fa-trash-alt me-2"></i> Waste Analysis</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-data">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="export-data">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="timeRangeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-calendar"></i> This Year
                </button>
                <ul class="dropdown-menu" aria-labelledby="timeRangeDropdown">
                    <li><a class="dropdown-item time-range" data-range="quarter" href="#">This Quarter</a></li>
                    <li><a class="dropdown-item time-range" data-range="year" href="#">This Year</a></li>
                    <li><a class="dropdown-item time-range" data-range="all" href="#">All Time</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Analysis Filters -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-filter me-2"></i> Analysis Filters</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="organizationFilter" class="form-label">Organization</label>
                    <select class="form-select" id="organizationFilter">
                        <option value="">All Organizations</option>
                        {% for organization in organizations %}
                            <option value="{{ organization.organization_id }}">{{ organization.organization.name if organization.organization else 'Unknown' }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="departmentFilter" class="form-label">Department</label>
                    <select class="form-select" id="departmentFilter" disabled>
                        <option value="">All Departments</option>
                        <!-- Will be populated based on organization selection -->
                    </select>
                </div>
            </div>
            <div class="row g-3 mt-1">
                <div class="col-md-6">
                    <label for="resourceTypeFilter" class="form-label">Resource Type</label>
                    <select class="form-select" id="resourceTypeFilter">
                        <option value="">All Resource Types</option>
                        <option value="equipment">Equipment</option>
                        <option value="supplies">Supplies</option>
                        <option value="staff">Staff</option>
                        <option value="facilities">Facilities</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="thresholdFilter" class="form-label">Waste Threshold (%)</label>
                    <input type="range" class="form-range" id="thresholdFilter" min="5" max="50" step="5" value="15">
                    <div class="d-flex justify-content-between">
                        <small>5%</small>
                        <small>25%</small>
                        <small>50%</small>
                    </div>
                    <div class="text-center mt-1">
                        <span class="badge bg-primary" id="thresholdValue">15%</span>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
                <button type="button" class="btn btn-primary" id="applyFilters">
                    <i class="fas fa-search me-2"></i> Apply Filters
                </button>
                <button type="button" class="btn btn-secondary ms-2" id="resetFilters">
                    <i class="fas fa-undo me-2"></i> Reset
                </button>
            </div>
        </div>
    </div>
    <!-- Waste Analysis Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Total Waste Identified</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalWasteAmount">$0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-trash fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Resources Affected</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="resourcesAffected">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-box fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Average Waste (%)</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="avgWastePercent">0%</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-percentage fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Optimization Potential</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="optimizationPotential">$0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resource Allocation Chart -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i> Resource Allocation vs Waste</h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="chartTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-chart-pie"></i> Pie Chart
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="chartTypeDropdown">
                            <li><a class="dropdown-item chart-type" data-type="pie" href="#">Pie Chart</a></li>
                            <li><a class="dropdown-item chart-type" data-type="bar" href="#">Bar Chart</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:400px;">
                        <canvas id="resourceAllocationChart"></canvas>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i> 
                        Resource allocation chart shows total allocation (blue) and identified waste (red) by resource category.
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i> Top Waste Categories</h5>
                </div>
                <div class="card-body">
                    <div id="topWasteCategories">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Analyzing waste data...</p>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <button type="button" class="btn btn-outline-primary" id="generateRecommendations">
                        <i class="fas fa-lightbulb me-2"></i> Generate Recommendations
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Detailed Waste Items -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-table me-2"></i> Detailed Waste Items</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="wasteItemsTable">
                    <thead>
                        <tr>
                            <th>Organization</th>
                            <th>Department</th>
                            <th>Resource</th>
                            <th>Actual Unit Cost</th>
                            <th>Average Unit Cost</th>
                            <th>Quantity</th>
                            <th>Excess Cost</th>
                            <th>Waste (%)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="wasteItemsTableBody">
                        <!-- Table will be populated by JavaScript -->
                        <tr>
                            <td colspan="9" class="text-center">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                Loading waste data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="dataTables_info" id="dataTableInfo">Showing 0 to 0 of 0 entries</div>
                <div class="dataTables_paginate">
                    <ul class="pagination" id="tablePagination">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">Previous</a>
                        </li>
                        <li class="page-item active">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Waste Trends Analysis -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Waste Trends</h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="trendResourceSelect" class="form-label">Select Resource</label>
                    <select class="form-select" id="trendResourceSelect">
                        <option value="">All Resources</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div class="col-md-8">
                    <label class="form-label">Time Period</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="timeperiod" id="tp1" value="30" autocomplete="off">
                        <label class="btn btn-outline-primary" for="tp1">Monthly</label>

                        <input type="radio" class="btn-check" name="timeperiod" id="tp2" value="90" autocomplete="off">
                        <label class="btn btn-outline-primary" for="tp2">Quarterly</label>

                        <input type="radio" class="btn-check" name="timeperiod" id="tp3" value="365" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="tp3">Annual</label>

                        <input type="radio" class="btn-check" name="timeperiod" id="tp4" value="all" autocomplete="off">
                        <label class="btn btn-outline-primary" for="tp4">All Time</label>
                    </div>
                </div>
            </div>
            <div id="trendChartContainer" style="height: 400px;">
                <canvas id="wasteTrendChart"></canvas>
            </div>
            <div id="trendNoDataMessage" class="alert alert-info text-center mt-3 d-none">
                <i class="fas fa-info-circle me-2"></i> Select a resource to view waste trends
            </div>
        </div>
    </div>
    <!-- Optimization Recommendations -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i> Optimization Recommendations</h5>
        </div>
        <div class="card-body" id="recommendationsSection">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i> 
                Click "Generate Recommendations" to analyze waste data and identify optimization opportunities.
            </div>
        </div>
    </div>
</div>

<!-- Recommendation Details Modal -->
<div class="modal fade" id="recommendationModal" tabindex="-1" aria-labelledby="recommendationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recommendationModalLabel">Recommendation Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="recommendationModalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveRecommendation">Save Recommendation</button>
            </div>
        </div>
    </div>
</div>

<!-- Waste Item Details Modal -->
<div class="modal fade" id="wasteItemModal" tabindex="-1" aria-labelledby="wasteItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="wasteItemModalLabel">Waste Item Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="wasteItemModalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize variables
        let wasteData = [];
        let resourceAllocationChart, wasteTrendChart;
        
        // Set up event handlers
        document.getElementById('applyFilters').addEventListener('click', function() {
            loadWasteData();
        });
        
        document.getElementById('resetFilters').addEventListener('click', function() {
            document.getElementById('organizationFilter').value = '';
            document.getElementById('departmentFilter').value = '';
            document.getElementById('resourceTypeFilter').value = '';
            document.getElementById('thresholdFilter').value = 15;
            document.getElementById('thresholdValue').textContent = '15%';
            document.getElementById('departmentFilter').disabled = true;
            loadWasteData();
        });
        
        document.getElementById('thresholdFilter').addEventListener('input', function() {
            document.getElementById('thresholdValue').textContent = this.value + '%';
        });
        
        document.getElementById('organizationFilter').addEventListener('change', function() {
            const organizationId = this.value;
            const departmentSelect = document.getElementById('departmentFilter');
            
            if (organizationId) {
                // Enable department filter and load departments for the selected organization
                departmentSelect.disabled = false;
                loadDepartments(organizationId);
            } else {
                // Disable and clear department filter
                departmentSelect.disabled = true;
                departmentSelect.innerHTML = '<option value="">All Departments</option>';
            }
        });
        
        document.getElementById('generateRecommendations').addEventListener('click', function() {
            generateRecommendations();
        });
        
        document.getElementById('saveRecommendation').addEventListener('click', function() {
            saveRecommendation();
        });
        
        document.getElementById('export-data').addEventListener('click', function() {
            exportToCSV('waste_analysis.csv');
        });
        
        document.getElementById('refresh-data').addEventListener('click', function() {
            loadWasteData();
        });
        
        document.getElementById('trendResourceSelect').addEventListener('change', function() {
            const resourceId = this.value;
            if (resourceId) {
                const timePeriod = document.querySelector('input[name="timeperiod"]:checked').value;
                loadWasteTrendData(resourceId, timePeriod);
                document.getElementById('trendNoDataMessage').classList.add('d-none');
            } else {
                document.getElementById('trendNoDataMessage').classList.remove('d-none');
                if (wasteTrendChart) {
                    wasteTrendChart.destroy();
                    wasteTrendChart = null;
                }
            }
        });
        
        document.querySelectorAll('input[name="timeperiod"]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                const resourceId = document.getElementById('trendResourceSelect').value;
                if (resourceId) {
                    loadWasteTrendData(resourceId, this.value);
                }
            });
        });
        
        // Chart type selectors
        document.querySelectorAll('.chart-type').forEach(function(item) {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const chartType = this.getAttribute('data-type');
                document.getElementById('chartTypeDropdown').innerHTML = 
                    `<i class="fas fa-chart-${chartType}"></i> ${this.textContent}`;
                updateChartType(chartType);
            });
        });
        
        // Load initial data
        loadWasteData();
        
        // Function to load waste data
        function loadWasteData() {
            const organizationId = document.getElementById('organizationFilter').value;
            const departmentId = document.getElementById('departmentFilter').value;
            const resourceType = document.getElementById('resourceTypeFilter').value;
            const wasteThreshold = document.getElementById('thresholdFilter').value;
            
            // Build query parameters
            let params = new URLSearchParams();
            if (organizationId) params.append('organization_id', organizationId);
            if (departmentId) params.append('department_id', departmentId);
            if (resourceType) params.append('resource_type', resourceType);
            params.append('threshold', wasteThreshold);
            
            // Show loading states
            document.getElementById('wasteItemsTableBody').innerHTML = `
                <tr>
                    <td colspan="9" class="text-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        Loading waste data...
                    </td>
                </tr>`;
                
            document.getElementById('topWasteCategories').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Analyzing waste data...</p>
                </div>`;
            
            // Fetch data from API
            fetch(`/analytics/waste-data?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    wasteData = data;
                    updateWasteTable(wasteData);
                    updateSummaryMetrics(wasteData);
                    updateResourceAllocationChart(wasteData);
                    updateTopWasteCategories(wasteData);
                    populateResourceDropdown(wasteData);
                })
                .catch(error => {
                    console.error('Error loading waste data:', error);
                    document.getElementById('wasteItemsTableBody').innerHTML = 
                        '<tr><td colspan="9" class="text-center text-danger">Error loading data. Please try again.</td></tr>';
                });
        }
        
        // Function to load departments for an organization
        function loadDepartments(organizationId) {
            const departmentSelect = document.getElementById('departmentFilter');
            
            // Show loading state
            departmentSelect.innerHTML = '<option value="">Loading departments...</option>';
            
            // Fetch departments from API
            fetch(`/api/departments?organization_id=${organizationId}`)
                .then(response => response.json())
                .then(data => {
                    // Clear loading state
                    departmentSelect.innerHTML = '<option value="">All Departments</option>';
                    
                    // Add department options
                    if (data && data.length > 0) {
                        data.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept.id;
                            option.textContent = dept.name;
                            departmentSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading departments:', error);
                    departmentSelect.innerHTML = '<option value="">Error loading departments</option>';
                });
        }
        
        // Function to update waste table
        function updateWasteTable(data) {
            const tableBody = document.getElementById('wasteItemsTableBody');
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center">No waste items found for the selected filters.</td></tr>';
                document.getElementById('dataTableInfo').textContent = 'Showing 0 to 0 of 0 entries';
                return;
            }
            
            // Generate table rows
            let html = '';
            data.forEach((item, index) => {
                const wastePct = ((item.actual_unit_cost - item.average_unit_cost) / item.average_unit_cost * 100).toFixed(1);
                const wasteClass = wastePct > 30 ? 'text-danger' : wastePct > 15 ? 'text-warning' : 'text-info';
                
                html += `
                <tr>
                    <td>${item.organization || 'N/A'}</td>
                    <td>${item.department || 'N/A'}</td>
                    <td>${item.resource}</td>
                    <td>$${item.actual_unit_cost.toFixed(2)}</td>
                    <td>$${item.average_unit_cost.toFixed(2)}</td>
                    <td>${item.quantity.toFixed(2)}</td>
                    <td>$${item.excess_cost.toFixed(2)}</td>
                    <td class="${wasteClass}">${wastePct}%</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-waste-item" data-index="${index}" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-waste-item').forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    showWasteItemDetails(wasteData[index]);
                });
            });
            
            // Update data table info
            document.getElementById('dataTableInfo').textContent = `Showing 1 to ${data.length} of ${data.length} entries`;
            
            // Update pagination
            updatePagination(data.length);
        }
        
        // Function to update summary metrics
        function updateSummaryMetrics(data) {
            if (!data || data.length === 0) {
                document.getElementById('totalWasteAmount').textContent = '$0';
                document.getElementById('resourcesAffected').textContent = '0';
                document.getElementById('avgWastePercent').textContent = '0%';
                document.getElementById('optimizationPotential').textContent = '$0';
                return;
            }
            
            // Calculate total waste amount
            const totalWaste = data.reduce((sum, item) => sum + item.excess_cost, 0);
            document.getElementById('totalWasteAmount').textContent = '$' + totalWaste.toFixed(2);
            
            // Count affected resources
            const uniqueResources = new Set(data.map(item => item.resource));
            document.getElementById('resourcesAffected').textContent = uniqueResources.size;
            
            // Calculate average waste percentage
            let totalWastePct = 0;
            data.forEach(item => {
                totalWastePct += ((item.actual_unit_cost - item.average_unit_cost) / item.average_unit_cost * 100);
            });
            const avgWastePct = totalWastePct / data.length;
            document.getElementById('avgWastePercent').textContent = avgWastePct.toFixed(1) + '%';
            
            // Calculate optimization potential (assume 80% of waste can be eliminated)
            const potential = totalWaste * 0.8;
            document.getElementById('optimizationPotential').textContent = '$' + potential.toFixed(2);
        }
        
        // Function to update resource allocation chart
        function updateResourceAllocationChart(data) {
            const ctx = document.getElementById('resourceAllocationChart').getContext('2d');
            
            // If no data, show message and return
            if (!data || data.length === 0) {
                if (resourceAllocationChart) {
                    resourceAllocationChart.destroy();
                    resourceAllocationChart = null;
                }
                return;
            }
            
            // Group data by resource
            const resourceGroups = {};
            const wasteByResource = {};
            
            data.forEach(item => {
                if (!resourceGroups[item.resource]) {
                    resourceGroups[item.resource] = 0;
                    wasteByResource[item.resource] = 0;
                }
                
                // Add total allocation (estimated based on average cost * quantity)
                const totalAllocation = item.average_unit_cost * item.quantity;
                resourceGroups[item.resource] += totalAllocation;
                
                // Add waste amount
                wasteByResource[item.resource] += item.excess_cost;
            });
            
            // Prepare chart data
            const resources = Object.keys(resourceGroups);
            const totalAllocations = resources.map(resource => resourceGroups[resource]);
            const totalWaste = resources.map(resource => wasteByResource[resource]);
            
            // Get chart type (pie or bar)
            const chartType = document.getElementById('chartTypeDropdown').textContent.includes('Bar') ? 'bar' : 'pie';
            
            // Chart data configuration
            const chartData = {
                labels: resources,
                datasets: []
            };
            
            if (chartType === 'pie') {
                // For pie chart, just show waste as percentage of total
                chartData.datasets = [{
                    label: 'Waste Percentage',
                    data: resources.map((resource, index) => 
                        (wasteByResource[resource] / resourceGroups[resource] * 100).toFixed(1)),
                    backgroundColor: resources.map((_, index) => 
                        `rgba(${220 + (index * 10) % 35}, ${53 + (index * 10) % 35}, ${69 + (index * 10) % 35}, 0.7)`),
                    borderWidth: 1
                }];
            } else {
                // For bar chart, show both total allocation and waste
                chartData.datasets = [
                    {
                        label: 'Total Allocation',
                        data: totalAllocations,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Waste Amount',
                        data: totalWaste,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ];
            }
            
            // Destroy existing chart if it exists
            if (resourceAllocationChart) {
                resourceAllocationChart.destroy();
            }
            
            // Create chart with appropriate type and data
            resourceAllocationChart = new Chart(ctx, {
                type: chartType,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (chartType === 'pie') {
                                        return `Waste: ${context.raw}%`;
                                    } else {
                                        return `${context.dataset.label}: $${context.raw.toFixed(2)}`;
                                    }
                                }
                            }
                        }
                    },
                    scales: chartType === 'bar' ? {
                        x: {
                            title: {
                                display: true,
                                text: 'Resources'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount ($)'
                            }
                        }
                    } : {}
                }
            });
        }
        
        // Function to update chart type
        function updateChartType(chartType) {
            if (resourceAllocationChart && wasteData.length > 0) {
                updateResourceAllocationChart(wasteData);
            }
        }
        
        // Function to update top waste categories
        function updateTopWasteCategories(data) {
            const container = document.getElementById('topWasteCategories');
            
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> 
                        No waste data found for the selected filters.
                    </div>`;
                return;
            }
            
            // Group by resource and calculate total waste for each
            const wasteByResource = {};
            data.forEach(item => {
                if (!wasteByResource[item.resource]) {
                    wasteByResource[item.resource] = 0;
                }
                wasteByResource[item.resource] += item.excess_cost;
            });
            
            // Sort resources by waste amount (descending)
            const sortedResources = Object.keys(wasteByResource).map(resource => ({
                name: resource,
                waste: wasteByResource[resource]
            })).sort((a, b) => b.waste - a.waste);
            
            // Limit to top 5
            const topResources = sortedResources.slice(0, 5);
            
            // Create HTML for top waste categories
            let html = '';
            topResources.forEach((resource, index) => {
                const progressColor = index === 0 ? 'danger' : 
                                     index === 1 ? 'warning' : 'info';
                
                // Calculate percentage of total waste
                const totalWaste = data.reduce((sum, item) => sum + item.excess_cost, 0);
                const wastePct = (resource.waste / totalWaste * 100).toFixed(1);
                
                html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>${resource.name}</span>
                        <span class="text-${progressColor}">$${resource.waste.toFixed(2)} (${wastePct}%)</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-${progressColor}" role="progressbar" style="width: ${wastePct}%" 
                         aria-valuenow="${wastePct}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>`;
            });
            
            // Add "Other" category if there are more than 5 resources
            if (sortedResources.length > 5) {
                const otherWaste = sortedResources.slice(5).reduce((sum, resource) => sum + resource.waste, 0);
                const totalWaste = data.reduce((sum, item) => sum + item.excess_cost, 0);
                const otherPct = (otherWaste / totalWaste * 100).toFixed(1);
                
                html += `
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Other Resources</span>
                        <span class="text-secondary">$${otherWaste.toFixed(2)} (${otherPct}%)</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-secondary" role="progressbar" style="width: ${otherPct}%" 
                         aria-valuenow="${otherPct}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>`;
            }
            
            container.innerHTML = html;
        }
        
        // Function to populate resource dropdown for trend chart
        function populateResourceDropdown(data) {
            const dropdown = document.getElementById('trendResourceSelect');
            
            // Preserve the first option (All Resources)
            const firstOption = dropdown.options[0];
            dropdown.innerHTML = '';
            dropdown.appendChild(firstOption);
            
            if (!data || data.length === 0) {
                return;
            }
            
            // Get unique resources
            const uniqueResources = [...new Set(data.map(item => item.resource))];
            
            // Add options to dropdown
            uniqueResources.forEach(resource => {
                const option = document.createElement('option');
                option.value = resource;
                option.textContent = resource;
                dropdown.appendChild(option);
            });
        }
        
        // Function to load waste trend data
        function loadWasteTrendData(resourceId, timePeriod) {
            // In a real application, this would make an API call
            // For this demonstration, we'll simulate with random data
            
            const now = new Date();
            const data = [];
            
            // Generate data points based on time period
            let numPoints, unit;
            if (timePeriod === '30') {
                numPoints = 12; // Last 12 months
                unit = 'month';
            } else if (timePeriod === '90') {
                numPoints = 12; // Last 12 quarters
                unit = 'quarter';
            } else if (timePeriod === '365') {
                numPoints = 5; // Last 5 years
                unit = 'year';
            } else { // all
                numPoints = 10; // 10 data points
                unit = 'year';
            }
            
            // Generate labels based on time unit
            const labels = [];
            for (let i = numPoints - 1; i >= 0; i--) {
                const date = new Date(now);
                if (unit === 'month') {
                    date.setMonth(date.getMonth() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));
                } else if (unit === 'quarter') {
                    date.setMonth(date.getMonth() - (i * 3));
                    const quarter = Math.floor(date.getMonth() / 3) + 1;
                    labels.push(`Q${quarter} ${date.getFullYear()}`);
                } else { // year
                    date.setFullYear(date.getFullYear() - i);
                    labels.push(date.getFullYear().toString());
                }
            }
            
            // Generate simulated waste data with a general downward trend (improvement over time)
            const baseValue = 10000 + Math.random() * 5000;
            const wasteAmounts = labels.map((_, index) => {
                // Start higher, trend downward with some randomness
                const trendFactor = 1 - (index / numPoints) * 0.4; // 40% decrease over time
                const randomFactor = 0.8 + Math.random() * 0.4; // +/- 20% randomness
                return baseValue * trendFactor * randomFactor;
            });
            
            // Calculate waste percentage (assume total allocation is relatively stable)
            const totalAllocation = baseValue * 1.5; // 150% of base value
            const wastePercentages = wasteAmounts.map(amount => (amount / totalAllocation) * 100);
            
            // Update chart
            updateWasteTrendChart(labels, wasteAmounts, wastePercentages);
        }
        
        // Function to update waste trend chart
        function updateWasteTrendChart(labels, wasteAmounts, wastePercentages) {
            const ctx = document.getElementById('wasteTrendChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (wasteTrendChart) {
                wasteTrendChart.destroy();
            }
            
            // Create new chart
            wasteTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Waste Amount ($)',
                            data: wasteAmounts,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            fill: true,
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'Waste Percentage (%)',
                            data: wastePercentages,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time Period'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Waste Amount ($)'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Waste Percentage (%)'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw;
                                    return `${label}: ${context.datasetIndex === 0 ? '$' : ''}${value.toFixed(2)}${context.datasetIndex === 1 ? '%' : ''}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Function to update pagination
        function updatePagination(dataCount) {
            const pagination = document.getElementById('tablePagination');
            const pageSize = 10; // Items per page
            const totalPages = Math.ceil(dataCount / pageSize);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            // Generate pagination links
            let html = `
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1">Previous</a>
                </li>`;
                
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                html += `
                    <li class="page-item ${i === 1 ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>`;
            }
            
            html += `
                <li class="page-item ${totalPages <= 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="2">Next</a>
                </li>`;
                
            pagination.innerHTML = html;
            
            // Add event listeners to pagination links
            pagination.querySelectorAll('.page-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const page = this.getAttribute('data-page');
                    if (!page) return;
                    
                    // Handle pagination (in a real app, this would load data for the specified page)
                    console.log(`Navigate to page ${page}`);
                    
                    // For demonstration, just update active state
                    pagination.querySelectorAll('.page-item').forEach(item => item.classList.remove('active'));
                    this.parentElement.classList.add('active');
                    
                    // Enable/disable Previous/Next buttons
                    pagination.querySelector('.page-item:first-child').classList.toggle('disabled', page === '1');
                    pagination.querySelector('.page-item:last-child').classList.toggle('disabled', page === totalPages.toString());
                    
                    // Update Next button page reference
                    const nextPage = Math.min(parseInt(page) + 1, totalPages);
                    pagination.querySelector('.page-item:last-child .page-link').setAttribute('data-page', nextPage);
                    
                    // Update Previous button page reference
                    const prevPage = Math.max(parseInt(page) - 1, 1);
                    pagination.querySelector('.page-item:first-child .page-link').setAttribute('data-page', prevPage);
                });
            });
        }
        
        // Function to show waste item details
        function showWasteItemDetails(item) {
            const modal = new bootstrap.Modal(document.getElementById('wasteItemModal'));
            const modalBody = document.getElementById('wasteItemModalBody');
            
            // Calculate waste percentage
            const wastePct = ((item.actual_unit_cost - item.average_unit_cost) / item.average_unit_cost * 100).toFixed(1);
            const wasteClass = wastePct > 30 ? 'danger' : wastePct > 15 ? 'warning' : 'info';
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Organization Information</h6>
                        <table class="table table-bordered">
                            <tr>
                                <th>Organization</th>
                                <td>${item.organization || 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>Department</th>
                                <td>${item.department || 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>Fiscal Year</th>
                                <td>${item.fiscal_year || 'Current'}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Resource Information</h6>
                        <table class="table table-bordered">
                            <tr>
                                <th>Resource</th>
                                <td>${item.resource}</td>
                            </tr>
                            <tr>
                                <th>Quantity</th>
                                <td>${item.quantity.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <th>Actual Unit Cost</th>
                                <td>$${item.actual_unit_cost.toFixed(2)}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div class="alert alert-${wasteClass} mt-3">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <strong>Waste Percentage</strong>
                            <h3>${wastePct}%</h3>
                        </div>
                        <div class="col-md-4 text-center">
                            <strong>Average Unit Cost</strong>
                            <h3>$${item.average_unit_cost.toFixed(2)}</h3>
                        </div>
                        <div class="col-md-4 text-center">
                            <strong>Excess Cost</strong>
                            <h3>$${item.excess_cost.toFixed(2)}</h3>
                        </div>
                    </div>
                </div>
                
                <h6 class="mt-4">Optimization Recommendations</h6>
                <ol>
                    <li>Evaluate current procurement processes for ${item.resource}</li>
                    <li>Compare pricing with alternative suppliers</li>
                    <li>Consider volume discounting or bundling with other resources</li>
                    <li>Standardize specifications to reduce customization costs</li>
                    <li>Implement regular price benchmarking for this resource</li>
                </ol>
                
                <div class="mt-4">
                    <h6>Estimated Annual Savings</h6>
                    <p>By implementing the recommended optimizations, estimated annual savings could be as high as <strong>$${(item.excess_cost * 0.8).toFixed(2)}</strong> (80% of excess cost).</p>
                </div>
            `;
            
            modal.show();
        }
        
        // Function to generate recommendations
        function generateRecommendations() {
            const recommendationsSection = document.getElementById('recommendationsSection');
            
            // Show loading state
            recommendationsSection.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Analyzing data and generating recommendations...</p>
                </div>`;
            
            // In a real app, this would make an API call to generate recommendations
            // For this demo, we'll simulate with a timeout
            setTimeout(() => {
                // Generate recommendations based on waste data
                if (!wasteData || wasteData.length === 0) {
                    recommendationsSection.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> 
                            No waste data available to generate recommendations.
                        </div>`;
                    return;
                }
                
                // Group waste items by resource
                const resourceWaste = {};
                wasteData.forEach(item => {
                    if (!resourceWaste[item.resource]) {
                        resourceWaste[item.resource] = {
                            totalWaste: 0,
                            items: []
                        };
                    }
                    resourceWaste[item.resource].totalWaste += item.excess_cost;
                    resourceWaste[item.resource].items.push(item);
                });
                
                // Sort resources by total waste (descending)
                const sortedResources = Object.keys(resourceWaste).map(resource => ({
                    name: resource,
                    totalWaste: resourceWaste[resource].totalWaste,
                    items: resourceWaste[resource].items
                })).sort((a, b) => b.totalWaste - a.totalWaste);
                
                // Generate html for recommendations
                let html = '';
                
                // Overall recommendation
                html += `
                <div class="alert alert-primary mb-4">
                    <h5><i class="fas fa-lightbulb me-2"></i> Key Findings</h5>
                    <p>Analysis has identified $${wasteData.reduce((sum, item) => sum + item.excess_cost, 0).toFixed(2)} in potential waste across ${Object.keys(resourceWaste).length} resource categories.</p>
                    <p class="mb-0">Implementing the following recommendations could result in estimated annual savings of $${(wasteData.reduce((sum, item) => sum + item.excess_cost, 0) * 0.8).toFixed(2)}.</p>
                </div>`;
                
                // Resource-specific recommendations
                sortedResources.slice(0, 3).forEach((resource, index) => {
                    const cardClass = index === 0 ? 'border-danger' : index === 1 ? 'border-warning' : 'border-info';
                    const iconClass = index === 0 ? 'danger' : index === 1 ? 'warning' : 'info';
                    
                    html += `
                    <div class="card ${cardClass} mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-exclamation-circle text-${iconClass} me-2"></i>
                                Optimize ${resource.name} Procurement
                            </h5>
                            <span class="badge bg-${iconClass}">Priority ${index + 1}</span>
                        </div>
                        <div class="card-body">
                            <p><strong>Potential Savings:</strong> $${resource.totalWaste.toFixed(2)}</p>
                            <p><strong>Finding:</strong> ${resource.name} costs are ${Math.floor(((resource.items[0].actual_unit_cost / resource.items[0].average_unit_cost) - 1) * 100)}% higher than benchmark averages.</p>
                            
                            <h6>Recommended Actions:</h6>
                            <ol>
                                <li>Review current ${resource.name} procurement processes</li>
                                <li>Obtain competitive bids from at least 3 alternative suppliers</li>
                                <li>Negotiate volume discounts based on projected annual usage</li>
                                <li>Standardize specifications to eliminate unnecessary customization</li>
                                <li>Implement regular price benchmarking for this resource category</li>
                            </ol>
                            
                            <button class="btn btn-sm btn-outline-primary view-recommendation" data-index="${index}">
                                View Detailed Recommendation
                            </button>
                        </div>
                    </div>`;
                });
                
                // More recommendations button if there are more resources
                if (sortedResources.length > 3) {
                    html += `
                    <div class="text-center">
                        <button class="btn btn-outline-primary" id="viewMoreRecommendations">
                            <i class="fas fa-plus-circle me-2"></i> View More Recommendations (${sortedResources.length - 3} more)
                        </button>
                    </div>`;
                }
                
                recommendationsSection.innerHTML = html;
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-recommendation').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        showRecommendationDetails(sortedResources[index]);
                    });
                });
                
                // Add event listener to "View More" button
                const viewMoreBtn = document.getElementById('viewMoreRecommendations');
                if (viewMoreBtn) {
                    viewMoreBtn.addEventListener('click', function() {
                        showMoreRecommendations(sortedResources.slice(3));
                    });
                }
            }, 1500);
        }
        
        // Function to show recommendation details
        function showRecommendationDetails(resource) {
            const modal = new bootstrap.Modal(document.getElementById('recommendationModal'));
            const modalBody = document.getElementById('recommendationModalBody');
            
            modalBody.innerHTML = `
                <div class="mb-4">
                    <h5>Optimization Recommendation for ${resource.name}</h5>
                    <p class="text-muted">Priority: High | Potential Savings: $${resource.totalWaste.toFixed(2)}</p>
                </div>
                
                <div class="alert alert-primary">
                    <h6><i class="fas fa-search me-2"></i> Finding</h6>
                    <p class="mb-0">Analysis has identified significant excess costs in ${resource.name} procurement. Current unit costs are approximately ${Math.floor(((resource.items[0].actual_unit_cost / resource.items[0].average_unit_cost) - 1) * 100)}% above industry benchmarks, resulting in estimated excess spending of $${resource.totalWaste.toFixed(2)}.</p>
                </div>
                
                <h6><i class="fas fa-tasks me-2"></i> Recommended Action Plan</h6>
                <div class="timeline mb-4">
                    <div class="timeline-item">
                        <div class="timeline-badge bg-primary">
                            <i class="fas fa-1"></i>
                        </div>
                        <div class="timeline-panel">
                            <div class="timeline-heading">
                                <h6 class="timeline-title">Short-term: Assessment (1-2 weeks)</h6>
                            </div>
                            <div class="timeline-body">
                                <ul>
                                    <li>Review current ${resource.name} procurement processes</li>
                                    <li>Analyze historical purchasing data and identify trends</li>
                                    <li>Document current specifications and requirements</li>
                                    <li>Identify key stakeholders and decision-makers</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-badge bg-info">
                            <i class="fas fa-2"></i>
                        </div>
                        <div class="timeline-panel">
                            <div class="timeline-heading">
                                <h6 class="timeline-title">Mid-term: Sourcing (2-4 weeks)</h6>
                            </div>
                            <div class="timeline-body">
                                <ul>
                                    <li>Develop RFP for ${resource.name} with standardized specifications</li>
                                    <li>Identify and vet alternative suppliers</li>
                                    <li>Issue RFP to at least 3 qualified suppliers</li>
                                    <li>Evaluate proposals based on total cost of ownership</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-badge bg-success">
                            <i class="fas fa-3"></i>
                        </div>
                        <div class="timeline-panel">
                            <div class="timeline-heading">
                                <h6 class="timeline-title">Long-term: Implementation (1-2 months)</h6>
                            </div>
                            <div class="timeline-body">
                                <ul>
                                    <li>Negotiate volume-based pricing with selected supplier(s)</li>
                                    <li>Develop and implement standardized ordering procedures</li>
                                    <li>Establish regular price benchmarking process</li>
                                    <li>Set up monitoring system to track savings</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h6><i class="fas fa-chart-line me-2"></i> Expected Outcomes</h6>
                <div class="row mb-4">
                    <div class="col-md-4 text-center mb-3 mb-md-0">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 class="text-success">$${(resource.totalWaste * 0.8).toFixed(2)}</h3>
                                <p class="text-muted mb-0">Expected Annual Savings</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center mb-3 mb-md-0">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 class="text-primary">${Math.floor(((resource.items[0].actual_unit_cost / resource.items[0].average_unit_cost) - 1) * 100)}%</h3>
                                <p class="text-muted mb-0">Cost Reduction</p>
                            </div>
                            </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 class="text-info">4-6</h3>
                                <p class="text-muted mb-0">Week Implementation</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h6><i class="fas fa-file-alt me-2"></i> Implementation Notes</h6>
                <div class="alert alert-light">
                    <p>The following departments/units should be involved in the implementation:</p>
                    <ul>
                        <li>Procurement/Purchasing</li>
                        <li>Finance</li>
                        <li>Departments currently using ${resource.name}</li>
                        <li>Quality Assurance (to ensure specification changes don't impact quality)</li>
                    </ul>
                    <p class="mb-0">Potential barriers may include resistance to change, existing supplier relationships, and concerns about quality impacts. Address these proactively through stakeholder engagement and clear communication of the cost-benefit analysis.</p>
                </div>
            `;
            
            modal.show();
        }
        
        // Function to show more recommendations
        function showMoreRecommendations(resources) {
            const recommendationsSection = document.getElementById('recommendationsSection');
            
            // Get existing content
            const existingContent = recommendationsSection.innerHTML;
            
            // Remove "View More" button
            const moreButton = document.getElementById('viewMoreRecommendations');
            if (moreButton) {
                moreButton.remove();
            }
            
            // Generate HTML for additional recommendations
            let additionalHtml = '';
            
            resources.forEach((resource, index) => {
                additionalHtml += `
                <div class="card border-secondary mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-circle text-secondary me-2"></i>
                            Optimize ${resource.name} Procurement
                        </h5>
                        <span class="badge bg-secondary">Priority ${index + 4}</span>
                    </div>
                    <div class="card-body">
                        <p><strong>Potential Savings:</strong> $${resource.totalWaste.toFixed(2)}</p>
                        <p><strong>Finding:</strong> ${resource.name} costs are ${Math.floor(((resource.items[0].actual_unit_cost / resource.items[0].average_unit_cost) - 1) * 100)}% higher than benchmark averages.</p>
                        
                        <h6>Recommended Actions:</h6>
                        <ol>
                            <li>Review current ${resource.name} procurement processes</li>
                            <li>Obtain competitive bids from alternative suppliers</li>
                            <li>Negotiate volume discounts based on projected usage</li>
                        </ol>
                        
                        <button class="btn btn-sm btn-outline-secondary view-additional-recommendation" data-index="${index + 3}">
                            View Detailed Recommendation
                        </button>
                    </div>
                </div>`;
            });
            
            // Add the additional recommendations to the existing content
            recommendationsSection.innerHTML = existingContent + additionalHtml;
            
            // Add event listeners to new view buttons
            document.querySelectorAll('.view-additional-recommendation').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    showRecommendationDetails(resources[index - 3]);
                });
            });
        }
        
        // Function to save recommendation
        function saveRecommendation() {
            // In a real application, this would save the recommendation to the database
            showToast('Recommendation saved successfully', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('recommendationModal'));
            modal.hide();
        }
        
        // Function to export to CSV
        function exportToCSV(filename) {
            // Get waste items table
            const table = document.getElementById('wasteItemsTable');
            if (!table) {
                showToast('No data available to export', 'warning');
                return;
            }
            
            // Create CSV content
            let csv = [];
            
            // Add header row
            const headers = [];
            const headerCells = table.querySelectorAll('thead th');
            headerCells.forEach(cell => {
                // Skip the "Actions" column
                if (cell.textContent !== 'Actions') {
                    headers.push(cell.textContent);
                }
            });
            csv.push(headers.join(','));
            
            // Add data rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                if (row.querySelector('td')?.colSpan === headerCells.length) {
                    // Skip rows with colspan (loading or no data messages)
                    return;
                }
                
                const rowData = [];
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, index) => {
                    // Skip the "Actions" column
                    if (index < cells.length - 1) {
                        let cellText = cell.textContent.trim();
                        // Remove $ from monetary values
                        cellText = cellText.replace('$', '');
                        // Remove % from percentage values
                        cellText = cellText.replace('%', '');
                        // Escape commas in cell text
                        if (cellText.includes(',')) {
                            cellText = `"${cellText}"`;
                        }
                        rowData.push(cellText);
                    }
                });
                csv.push(rowData.join(','));
            });
            
            // Create and download CSV file
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            // Create download link
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Export successful', 'success');
        }
        
        // Function to show toast notification
        function showToast(message, type = 'info') {
            // Create toast container if it doesn't exist
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type}`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            // Create toast content
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            // Add toast to container
            toastContainer.appendChild(toast);
            
            // Initialize and show toast
            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 3000
            });
            bsToast.show();
            
            // Remove toast after it's hidden
            toast.addEventListener('hidden.bs.toast', function() {
                toast.remove();
            });
        }
    });
</script>
<style>
    /* Timeline styles for recommendation details */
    .timeline {
        position: relative;
        padding: 1rem 0;
    }
    
    .timeline:before {
        content: '';
        position: absolute;
        height: 100%;
        width: 4px;
        background: #e9ecef;
        left: 31px;
        top: 0;
        border-radius: 2px;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 30px;
    }
    
    .timeline-badge {
        position: absolute;
        top: 0;
        left: 16px;
        width: 34px;
        height: 34px;
        z-index: 100;
        border-radius: 50%;
        text-align: center;
        padding-top: 7px;
        font-weight: 600;
        color: white;
    }
    
    .timeline-panel {
        position: relative;
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 15px;
        margin-left: 60px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .timeline-title {
        margin-top: 0;
        margin-bottom: 5px;
        font-weight: 600;
    }
    
    .timeline-body > p {
        margin-bottom: 0;
    }
    
    .timeline-footer {
        margin-top: 10px;
    }
</style>
{% endblock %}