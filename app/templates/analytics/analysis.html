<!-- app/templates/analytics/analysis.html - Analytics analysis page -->
{% extends 'base.html' %}

{% block title %}Analytics Analysis | HealthEconomics360{% endblock %}

{% block content %}
<div class="container-fluid pt-3">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="fas fa-chart-line me-2"></i> Analytics Analysis</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-analysis">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="export-analysis">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="analysisTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-filter"></i> All Analyses
                </button>
                <ul class="dropdown-menu" aria-labelledby="analysisTypeDropdown">
                    <li><a class="dropdown-item analysis-type" data-type="all" href="#">All Analyses</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item analysis-type" data-type="price" href="#">Price Analysis</a></li>
                    <li><a class="dropdown-item analysis-type" data-type="resource" href="#">Resource Analysis</a></li>
                    <li><a class="dropdown-item analysis-type" data-type="outcome" href="#">Outcome Analysis</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Analysis Selection Tabs -->
    <ul class="nav nav-tabs mb-4" id="analysisTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="price-outcome-tab" data-bs-toggle="tab" data-bs-target="#price-outcome" type="button" role="tab" aria-controls="price-outcome" aria-selected="true">
                <i class="fas fa-balance-scale me-2"></i> Price-Outcome Analysis
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="resource-optimization-tab" data-bs-toggle="tab" data-bs-target="#resource-optimization" type="button" role="tab" aria-controls="resource-optimization" aria-selected="false">
                <i class="fas fa-sliders-h me-2"></i> Resource Optimization
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="regional-disparities-tab" data-bs-toggle="tab" data-bs-target="#regional-disparities" type="button" role="tab" aria-controls="regional-disparities" aria-selected="false">
                <i class="fas fa-globe-americas me-2"></i> Regional Disparities
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="trend-analysis-tab" data-bs-toggle="tab" data-bs-target="#trend-analysis" type="button" role="tab" aria-controls="trend-analysis" aria-selected="false">
                <i class="fas fa-chart-line me-2"></i> Trend Analysis
            </button>
        </li>
    </ul>

    <!-- Analysis Content Tabs -->
    <div class="tab-content" id="analysisTabContent">
        <!-- Price-Outcome Analysis Tab -->
        <div class="tab-pane fade show active" id="price-outcome" role="tabpanel" aria-labelledby="price-outcome-tab">
            <div class="row">
                <!-- Filters Card -->
                <div class="col-lg-3 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-filter me-2"></i> Analysis Filters</h5>
                        </div>
                        <div class="card-body">
                            <form id="priceOutcomeFiltersForm">
                                <div class="mb-3">
                                    <label for="treatmentSelect" class="form-label">Treatment</label>
                                    <select class="form-select" id="treatmentSelect">
                                        <option value="">All Treatments</option>
                                        <!-- Treatment options will be populated via JavaScript -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="outcomeSelect" class="form-label">Outcome Measure</label>
                                    <select class="form-select" id="outcomeSelect">
                                        <option value="">All Outcomes</option>
                                        <!-- Outcome options will be populated via JavaScript -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="organizationSelect" class="form-label">Organization</label>
                                    <select class="form-select" id="organizationSelect">
                                        <option value="">All Organizations</option>
                                        <!-- Organization options will be populated via JavaScript -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="priceRangeMin" class="form-label">Price Range ($)</label>
                                    <div class="row">
                                        <div class="col">
                                            <input type="number" class="form-control" id="priceRangeMin" placeholder="Min">
                                        </div>
                                        <div class="col">
                                            <input type="number" class="form-control" id="priceRangeMax" placeholder="Max">
                                        </div>
                                    </div>
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" id="applyPriceOutcomeFilters">
                                        <i class="fas fa-search me-2"></i> Apply Filters
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Analysis Metrics Card -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-calculator me-2"></i> Analysis Metrics</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Efficiency Measure</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="efficiencyMeasure" id="costEffectivenessRatio" value="cer" checked>
                                    <label class="form-check-label" for="costEffectivenessRatio">
                                        Cost-Effectiveness Ratio
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="efficiencyMeasure" id="incrementalCost" value="icer">
                                    <label class="form-check-label" for="incrementalCost">
                                        Incremental Cost-Effectiveness
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="efficiencyMeasure" id="netBenefit" value="nmb">
                                    <label class="form-check-label" for="netBenefit">
                                        Net Monetary Benefit
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="thresholdValue" class="form-label">Willingness-to-Pay Threshold ($)</label>
                                <input type="number" class="form-control" id="thresholdValue" value="50000">
                                <div class="form-text">Used for Net Monetary Benefit calculation</div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="button" class="btn btn-outline-primary" id="updateAnalysisMetrics">
                                    <i class="fas fa-calculator me-2"></i> Update Metrics
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Analysis Content -->
                <div class="col-lg-9">
                    <!-- Scatter Plot Card -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-chart-scatter me-2"></i> Price-Outcome Relationship</h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="chartTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-chart-scatter"></i> Scatter Plot
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="chartTypeDropdown">
                                    <li><a class="dropdown-item chart-type" data-type="scatter" href="#">Scatter Plot</a></li>
                                    <li><a class="dropdown-item chart-type" data-type="bubble" href="#">Bubble Chart</a></li>
                                    <li><a class="dropdown-item chart-type" data-type="bar" href="#">Bar Chart</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="position: relative; height:400px;">
                                <canvas id="priceOutcomeChart"></canvas>
                            </div>
                        </div>
                        <div class="card-footer">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i> 
                                Bubble size indicates sample size. Hover over points for details.
                                Higher position indicates better outcomes.
                            </small>
                        </div>
                    </div>
                    
                    <!-- Efficiency Ranking Card -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-trophy me-2"></i> Efficiency Ranking</h5>
                            <button class="btn btn-sm btn-outline-secondary" id="toggleEfficiencyTable">
                                <i class="fas fa-eye"></i> Show Full Table
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <!-- Top 3 Treatments -->
                                <div class="col-md-4 mb-4 mb-md-0">
                                    <div class="card h-100 border-success">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="mb-0 text-center">
                                                <i class="fas fa-trophy me-2"></i> #1 Rank
                                            </h5>
                                        </div>
                                        <div class="card-body text-center" id="rank1Card">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-4 mb-md-0">
                                    <div class="card h-100 border-info">
                                        <div class="card-header bg-info text-white">
                                            <h5 class="mb-0 text-center">
                                                <i class="fas fa-trophy me-2"></i> #2 Rank
                                            </h5>
                                        </div>
                                        <div class="card-body text-center" id="rank2Card">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="card h-100 border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0 text-center">
                                                <i class="fas fa-trophy me-2"></i> #3 Rank
                                            </h5>
                                        </div>
                                        <div class="card-body text-center" id="rank3Card">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Full Efficiency Table (Hidden by default) -->
                            <div class="table-responsive collapse" id="efficiencyTable">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>Treatment</th>
                                            <th>Outcome Measure</th>
                                            <th>Outcome Value</th>
                                            <th>Cost ($)</th>
                                            <th>Efficiency Ratio</th>
                                            <th>Organization</th>
                                        </tr>
                                    </thead>
                                    <tbody id="efficiencyTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center">
                                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <span class="ms-2">Loading data...</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analysis Insights Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i> Analysis Insights</h5>
                        </div>
                        <div class="card-body">
                            <div id="priceOutcomeInsights">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-3">Generating insights...</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-center">
                            <button type="button" class="btn btn-primary" id="generateRecommendations">
                                <i class="fas fa-magic me-2"></i> Generate Recommendations
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Resource Optimization Tab -->
        <div class="tab-pane fade" id="resource-optimization" role="tabpanel" aria-labelledby="resource-optimization-tab">
            <div class="row">
                <!-- Filters Card -->
                <div class="col-lg-3 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-filter me-2"></i> Resource Filters</h5>
                        </div>
                        <div class="card-body">
                            <form id="resourceFiltersForm">
                                <div class="mb-3">
                                    <label for="resourceOrgSelect" class="form-label">Organization</label>
                                    <select class="form-select" id="resourceOrgSelect">
                                        <option value="">All Organizations</option>
                                        <!-- Organization options will be populated via JavaScript -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="departmentSelect" class="form-label">Department</label>
                                    <select class="form-select" id="departmentSelect">
                                        <option value="">All Departments</option>
                                        <!-- Department options will be populated via JavaScript -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="resourceTypeSelect" class="form-label">Resource Type</label>
                                    <select class="form-select" id="resourceTypeSelect">
                                        <option value="">All Resources</option>
                                        <!-- Resource options will be populated via JavaScript -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="fiscalYearSelect" class="form-label">Fiscal Year</label>
                                    <select class="form-select" id="fiscalYearSelect">
                                        <option value="">All Years</option>
                                        <option value="2024-2025">2024-2025</option>
                                        <option value="2023-2024">2023-2024</option>
                                        <option value="2022-2023">2022-2023</option>
                                    </select>
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" id="applyResourceFilters">
                                        <i class="fas fa-search me-2"></i> Apply Filters
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Resource Analysis Parameters -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-cogs me-2"></i> Analysis Parameters</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Detection Sensitivity</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="sensitivityLevel" id="sensitivityLow" value="low">
                                    <label class="form-check-label" for="sensitivityLow">
                                        Low (Few Suggestions)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="sensitivityLevel" id="sensitivityMedium" value="medium" checked>
                                    <label class="form-check-label" for="sensitivityMedium">
                                        Medium (Balanced)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="sensitivityLevel" id="sensitivityHigh" value="high">
                                    <label class="form-check-label" for="sensitivityHigh">
                                        High (Many Suggestions)
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="wastageThreshold" class="form-label">Wastage Threshold (%)</label>
                                <input type="number" class="form-control" id="wastageThreshold" value="15">
                                <div class="form-text">Deviation percentage considered as waste</div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="button" class="btn btn-outline-primary" id="updateResourceParameters">
                                    <i class="fas fa-sync-alt me-2"></i> Update Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Analysis Content -->
                <div class="col-lg-9">
                    <!-- Resource Allocation Chart -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i> Resource Allocation</h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="resourceChartTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-chart-pie"></i> Pie Chart
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="resourceChartTypeDropdown">
                                    <li><a class="dropdown-item resource-chart-type" data-type="pie" href="#">Pie Chart</a></li>
                                    <li><a class="dropdown-item resource-chart-type" data-type="bar" href="#">Bar Chart</a></li>
                                    <li><a class="dropdown-item resource-chart-type" data-type="tree" href="#">Tree Map</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="position: relative; height:400px;">
                                <canvas id="resourceAllocationChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Waste Identification Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i> Potential Waste Identified</h5>
                        </div>
                        <div class="card-body">
                            <div id="wasteContainer">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-3">Analyzing resource allocation for waste...</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-center">
                            <button type="button" class="btn btn-primary" id="generateWasteReport">
                                <i class="fas fa-file-pdf me-2"></i> Generate Detailed Report
                            </button>
                        </div>
                    </div>
                    
                    <!-- Optimization Recommendations -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i> Optimization Recommendations</h5>
                        </div>
                        <div class="card-body">
                            <div id="resourceRecommendations">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> 
                                    Click "Generate Recommendations" to analyze resource allocations and identify optimization opportunities.
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-center">
                            <button type="button" class="btn btn-primary" id="generateResourceRecommendations">
                                <i class="fas fa-magic me-2"></i> Generate Recommendations
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Regional Disparities Tab -->
        <div class="tab-pane fade" id="regional-disparities" role="tabpanel" aria-labelledby="regional-disparities-tab">
            <div class="row">
                <!-- Filters Card -->
                <div class="col-lg-3 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-filter me-2"></i> Regional Filters</h5>
                        </div>
                        <div class="card-body">
                            <form id="regionalFiltersForm">
                                <div class="mb-3">
                                    <label for="regionSelect" class="form-label">Regions</label>
                                    <select class="form-select" id="regionSelect" multiple size="5">
                                        <!-- Region options will be populated via JavaScript -->
                                        <option value="loading" disabled>Loading regions...</option>
                                    </select>
                                    <div class="form-text">Hold Ctrl/Cmd to select multiple</div>
                                </div>
                                <div class="mb-3">
                                    <label for="regionalDrugSelect" class="form-label">Drug</label>
                                    <select class="form-select" id="regionalDrugSelect">
                                        <option value="">All Drugs</option>
                                        <!-- Drug options will be populated via JavaScript -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="disparityMetricSelect" class="form-label">Disparity Metric</label>
                                    <select class="form-select" id="disparityMetricSelect">
                                        <option value="max_diff">Max Difference</option>
                                        <option value="max_ratio">Max Ratio</option>
                                        <option value="std_dev">Standard Deviation</option>
                                        <option value="gini">Gini Coefficient</option>
                                    </select>
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" id="applyRegionalFilters">
                                        <i class="fas fa-search me-2"></i> Apply Filters
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Regional Analysis Summary -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i> Analysis Summary</h5>
                        </div>
                        <div class="card-body">
                            <div id="regionalSummary">
                                <div class="text-center py-4">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Loading summary...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Analysis Content -->
                <div class="col-lg-9">
                    <!-- Regional Map Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-map me-2"></i> Price Disparity Map</h5>
                        </div>
                        <div class="card-body">
                            <div id="regionalMap" style="height: 500px;">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-3">Loading regional map data...</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i> 
                                Darker colors indicate higher prices. Hover over regions for details.
                            </small>
                        </div>
                    </div>
                    
                    <!-- Regional Comparison Card -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Regional Price Comparison</h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="regionalChartTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-chart-bar"></i> Bar Chart
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="regionalChartTypeDropdown">
                                    <li><a class="dropdown-item regional-chart-type" data-type="bar" href="#">Bar Chart</a></li>
                                    <li><a class="dropdown-item regional-chart-type" data-type="line" href="#">Line Chart</a></li>
                                    <li><a class="dropdown-item regional-chart-type" data-type="radar" href="#">Radar Chart</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="position: relative; height:400px;">
                                <canvas id="regionalComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Regional Insights Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i> Regional Insights</h5>
                        </div>
                        <div class="card-body">
                            <div id="regionalInsights">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> 
                                    Select regions and apply filters to generate insights on regional price disparities.
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-center">
                            <button type="button" class="btn btn-primary" id="generateRegionalReport">
                                <i class="fas fa-file-export me-2"></i> Generate Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Trend Analysis Tab -->
            <div class="tab-pane fade" id="trend-analysis" role="tabpanel" aria-labelledby="trend-analysis-tab">
                <div class="row">
                    <!-- Filters Card -->
                    <div class="col-lg-3 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-filter me-2"></i> Trend Filters</h5>
                            </div>
                            <div class="card-body">
                                <form id="trendFiltersForm">
                                    <div class="mb-3">
                                        <label for="trendTypeSelect" class="form-label">Analysis Type</label>
                                        <select class="form-select" id="trendTypeSelect">
                                            <option value="price">Price Trends</option>
                                            <option value="outcome">Outcome Trends</option>
                                            <option value="resource">Resource Allocation Trends</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="trendDrugSelect" class="form-label">Drug/Treatment</label>
                                        <select class="form-select" id="trendDrugSelect">
                                            <option value="">Select Drug...</option>
                                            <!-- Drug options will be populated via JavaScript -->
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="trendRegionSelect" class="form-label">Region</label>
                                        <select class="form-select" id="trendRegionSelect">
                                            <option value="">All Regions</option>
                                            <!-- Region options will be populated via JavaScript -->
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="trendTimeRange" class="form-label">Time Range</label>
                                        <select class="form-select" id="trendTimeRange">
                                            <option value="1">Last Year</option>
                                            <option value="2">Last 2 Years</option>
                                            <option value="3">Last 3 Years</option>
                                            <option value="5">Last 5 Years</option>
                                            <option value="all" selected>All Time</option>
                                        </select>
                                    </div>
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-primary" id="applyTrendFilters">
                                            <i class="fas fa-search me-2"></i> Apply Filters
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Trend Analysis Options -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i> Analysis Options</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Moving Average Window</label>
                                    <select class="form-select" id="movingAverageWindow">
                                        <option value="none">No Smoothing</option>
                                        <option value="3" selected>3-point</option>
                                        <option value="5">5-point</option>
                                        <option value="7">7-point</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Trend Line</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showTrendLine" checked>
                                        <label class="form-check-label" for="showTrendLine">
                                            Show Trend Line
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Seasonality</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showSeasonality">
                                        <label class="form-check-label" for="showSeasonality">
                                            Show Seasonal Pattern
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Forecast</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showForecast">
                                        <label class="form-check-label" for="showForecast">
                                            Show Forecast
                                        </label>
                                    </div>
                                    <select class="form-select mt-2" id="forecastPeriods" disabled>
                                        <option value="3">3 Months</option>
                                        <option value="6">6 Months</option>
                                        <option value="12">12 Months</option>
                                    </select>
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-outline-primary" id="updateTrendOptions">
                                        <i class="fas fa-sync-alt me-2"></i> Update Chart
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Analysis Content -->
                    <div class="col-lg-9">
                        <!-- Trend Chart Card -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> <span id="trendChartTitle">Trend Analysis</span></h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="trendChartTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-chart-line"></i> Line Chart
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="trendChartTypeDropdown">
                                        <li><a class="dropdown-item trend-chart-type" data-type="line" href="#">Line Chart</a></li>
                                        <li><a class="dropdown-item trend-chart-type" data-type="bar" href="#">Bar Chart</a></li>
                                        <li><a class="dropdown-item trend-chart-type" data-type="area" href="#">Area Chart</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height:400px;">
                                    <canvas id="trendAnalysisChart"></canvas>
                                </div>
                            </div>
                            <div class="card-footer">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i> 
                                    <span id="trendChartFooter">Select a drug and apply filters to see trend analysis.</span>
                                </small>
                            </div>
                        </div>
                        
                        <!-- Trend Analysis Results -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Trend Analysis Results</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-4" id="trendMetrics">
                                    <div class="col-md-4 mb-3 mb-md-0">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Overall Trend</h6>
                                                <div class="trend-indicator">
                                                    <span class="trend-unknown" id="overallTrendIndicator">
                                                        <i class="fas fa-minus"></i>
                                                    </span>
                                                </div>
                                                <h3 id="overallTrendValue">--</h3>
                                                <p class="mb-0" id="overallTrendDesc">No data available</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3 mb-md-0">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Volatility</h6>
                                                <div class="trend-indicator">
                                                    <span class="trend-neutral" id="volatilityIndicator">
                                                        <i class="fas fa-minus"></i>
                                                    </span>
                                                </div>
                                                <h3 id="volatilityValue">--</h3>
                                                <p class="mb-0" id="volatilityDesc">No data available</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h6 class="text-muted mb-2">Forecast (6mo)</h6>
                                                <div class="trend-indicator">
                                                    <span class="trend-unknown" id="forecastIndicator">
                                                        <i class="fas fa-minus"></i>
                                                    </span>
                                                </div>
                                                <h3 id="forecastValue">--</h3>
                                                <p class="mb-0" id="forecastDesc">No data available</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="trendAnalysisDetails">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i> 
                                        Select a drug and apply filters to see detailed trend analysis.
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer text-center">
                                <button type="button" class="btn btn-primary" id="generateTrendReport">
                                    <i class="fas fa-file-download me-2"></i> Download Analysis Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Generate Recommendations Modal -->
    <div class="modal fade" id="recommendationsModal" tabindex="-1" aria-labelledby="recommendationsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recommendationsModalLabel">Generated Recommendations</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="recommendationsContent">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Generating recommendations...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveRecommendations">
                        <i class="fas fa-save me-2"></i> Save Recommendations
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}
    
    {% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize analytics analysis functionality
            initAnalyticsAnalysis();
            
            // Set up event handlers
            setupAnalyticsEventHandlers();
        });
        
        /**
         * Initialize analytics analysis functionality
         */
        function initAnalyticsAnalysis() {
            // Load initial data for the currently active tab
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab) {
                loadTabData(activeTab.id);
            }
            
            // Load filters data
            loadFilterOptions();
        }
        
        /**
         * Set up event handlers for analytics analysis
         */
        function setupAnalyticsEventHandlers() {
            // Tab change event
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(function(tab) {
                tab.addEventListener('shown.bs.tab', function(event) {
                    loadTabData(event.target.id);
                });
            });
            
            // Filter buttons
            document.getElementById('applyPriceOutcomeFilters')?.addEventListener('click', function() {
                loadPriceOutcomeData();
            });
            
            document.getElementById('applyResourceFilters')?.addEventListener('click', function() {
                loadResourceData();
            });
            
            document.getElementById('applyRegionalFilters')?.addEventListener('click', function() {
                loadRegionalData();
            });
            
            document.getElementById('applyTrendFilters')?.addEventListener('click', function() {
                loadTrendData();
            });
            
            // Update buttons
            document.getElementById('updateAnalysisMetrics')?.addEventListener('click', function() {
                updatePriceOutcomeMetrics();
            });
            
            document.getElementById('updateResourceParameters')?.addEventListener('click', function() {
                updateResourceAnalysis();
            });
            
            document.getElementById('updateTrendOptions')?.addEventListener('click', function() {
                updateTrendAnalysis();
            });
            
            // Generate buttons
            document.getElementById('generateRecommendations')?.addEventListener('click', function() {
                generatePriceOutcomeRecommendations();
            });
            
            document.getElementById('generateResourceRecommendations')?.addEventListener('click', function() {
                generateResourceRecommendations();
            });
            
            document.getElementById('generateWasteReport')?.addEventListener('click', function() {
                generateWasteReport();
            });
            
            document.getElementById('generateRegionalReport')?.addEventListener('click', function() {
                generateRegionalReport();
            });
            
            document.getElementById('generateTrendReport')?.addEventListener('click', function() {
                generateTrendReport();
            });
            
            // Toggle efficiency table
            document.getElementById('toggleEfficiencyTable')?.addEventListener('click', function() {
                const tableDiv = document.getElementById('efficiencyTable');
                const buttonIcon = this.querySelector('i');
                
                if (tableDiv.classList.contains('show')) {
                    tableDiv.classList.remove('show');
                    buttonIcon.classList.remove('fa-eye-slash');
                    buttonIcon.classList.add('fa-eye');
                    this.innerHTML = '<i class="fas fa-eye"></i> Show Full Table';
                } else {
                    tableDiv.classList.add('show');
                    buttonIcon.classList.remove('fa-eye');
                    buttonIcon.classList.add('fa-eye-slash');
                    this.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Full Table';
                }
            });
            
            // Chart type selectors
            document.querySelectorAll('.chart-type').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const chartType = this.getAttribute('data-type');
                    document.getElementById('chartTypeDropdown').innerHTML = `<i class="fas fa-chart-${chartType}"></i> ${this.textContent}`;
                    updatePriceOutcomeChartType(chartType);
                });
            });
            
            document.querySelectorAll('.resource-chart-type').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const chartType = this.getAttribute('data-type');
                    document.getElementById('resourceChartTypeDropdown').innerHTML = `<i class="fas fa-chart-${chartType}"></i> ${this.textContent}`;
                    updateResourceChartType(chartType);
                });
            });
            
            document.querySelectorAll('.regional-chart-type').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const chartType = this.getAttribute('data-type');
                    document.getElementById('regionalChartTypeDropdown').innerHTML = `<i class="fas fa-chart-${chartType}"></i> ${this.textContent}`;
                    updateRegionalChartType(chartType);
                });
            });
            
            document.querySelectorAll('.trend-chart-type').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const chartType = this.getAttribute('data-type');
                    document.getElementById('trendChartTypeDropdown').innerHTML = `<i class="fas fa-chart-${chartType}"></i> ${this.textContent}`;
                    updateTrendChartType(chartType);
                });
            });
            
            // Analysis type dropdown
            document.querySelectorAll('.analysis-type').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const analysisType = this.getAttribute('data-type');
                    document.getElementById('analysisTypeDropdown').innerHTML = `<i class="fas fa-filter"></i> ${this.textContent}`;
                    filterAnalysisByType(analysisType);
                });
            });
            
            // Forecast toggle
            document.getElementById('showForecast')?.addEventListener('change', function() {
                document.getElementById('forecastPeriods').disabled = !this.checked;
            });
            
            // Treatment/outcome dependency
            document.getElementById('treatmentSelect')?.addEventListener('change', function() {
                updateOutcomeSelectOptions(this.value);
            });
            
            // Organization/department dependency
            document.getElementById('resourceOrgSelect')?.addEventListener('change', function() {
                updateDepartmentSelectOptions(this.value);
            });
            
            // Save recommendations
            document.getElementById('saveRecommendations')?.addEventListener('click', function() {
                saveRecommendations();
            });
        }
        
        /**
         * Load data for tab
         * @param {string} tabId - ID of tab to load data for
         */
        function loadTabData(tabId) {
            switch (tabId) {
                case 'price-outcome-tab':
                    loadPriceOutcomeData();
                    break;
                case 'resource-optimization-tab':
                    loadResourceData();
                    break;
                case 'regional-disparities-tab':
                    loadRegionalData();
                    break;
                case 'trend-analysis-tab':
                    loadTrendData();
                    break;
            }
        }
        
        /**
         * Load filter options for all tabs
         */
        function loadFilterOptions() {
            // Load treatments
            fetch('/api/drugs')
                .then(response => response.json())
                .then(data => {
                    updateSelectOptions('treatmentSelect', data, 'name', 'id');
                    updateSelectOptions('trendDrugSelect', data, 'name', 'id');
                    updateSelectOptions('regionalDrugSelect', data, 'name', 'id');
                })
                .catch(error => console.error('Error loading treatments:', error));
            
            // Load outcomes
            fetch('/api/outcomes')
                .then(response => response.json())
                .then(data => {
                    // Group outcomes by treatment
                    const outcomesByTreatment = {};
                    
                    data.forEach(outcome => {
                        const treatmentId = outcome.treatment ? outcome.treatment.id : 'none';
                        
                        if (!outcomesByTreatment[treatmentId]) {
                            outcomesByTreatment[treatmentId] = [];
                        }
                        
                        outcomesByTreatment[treatmentId].push({
                            id: outcome.id,
                            name: outcome.outcome
                        });
                    });
                    
                    // Store for later use
                    window.outcomesByTreatment = outcomesByTreatment;
                    
                    // Update outcome select with all outcomes
                    const allOutcomes = data.map(outcome => ({
                        id: outcome.id,
                        name: outcome.outcome
                    }));
                    
                    updateSelectOptions('outcomeSelect', allOutcomes, 'name', 'id');
                })
                .catch(error => console.error('Error loading outcomes:', error));
            
            // Load organizations
            fetch('/api/organizations')
                .then(response => response.json())
                .then(data => {
                    updateSelectOptions('organizationSelect', data, 'name', 'id');
                    updateSelectOptions('resourceOrgSelect', data, 'name', 'id');
                })
                .catch(error => console.error('Error loading organizations:', error));
            
            // Load regions
            fetch('/api/regions')
                .then(response => response.json())
                .then(data => {
                    updateSelectOptions('regionSelect', data, 'name', 'id', true);
                    updateSelectOptions('trendRegionSelect', data, 'name', 'id');
                })
                .catch(error => console.error('Error loading regions:', error));
            
            // Load resource types
            fetch('/api/resources')
                .then(response => response.json())
                .then(data => {
                    const resourceTypes = [...new Set(data.map(item => item.category))].map(
                        category => ({ id: category, name: category })
                    );
                    updateSelectOptions('resourceTypeSelect', resourceTypes, 'name', 'id');
                })
                .catch(error => console.error('Error loading resource types:', error));
        }
        
        /**
         * Update select element options
         * @param {string} selectId - ID of select element
         * @param {Array} data - Array of option data
         * @param {string} textProperty - Property to use for option text
         * @param {string} valueProperty - Property to use for option value
         * @param {boolean} multiple - Whether select supports multiple selection
         */
        function updateSelectOptions(selectId, data, textProperty, valueProperty, multiple = false) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Preserve the first option (usually "All" or "Select")
            const firstOption = select.options[0];
            
            // Clear existing options
            select.innerHTML = '';
            
            // Add back the first option
            if (firstOption) {
                select.appendChild(firstOption);
            }
            
            // Add new options
            if (data && data.length > 0) {
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item[valueProperty];
                    option.textContent = item[textProperty];
                    select.appendChild(option);
                });
            } else {
                // Add a "No data" option if no data is available
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No data available';
                option.disabled = true;
                select.appendChild(option);
            }
        }
        
        /**
         * Update outcome select options based on selected treatment
         * @param {string} treatmentId - Selected treatment ID
         */
        function updateOutcomeSelectOptions(treatmentId) {
            const outcomeSelect = document.getElementById('outcomeSelect');
            if (!outcomeSelect || !window.outcomesByTreatment) return;
            
            // Preserve the first option
            const firstOption = outcomeSelect.options[0];
            
            // Clear existing options
            outcomeSelect.innerHTML = '';
            
            // Add back the first option
            if (firstOption) {
                outcomeSelect.appendChild(firstOption);
            }
            
            // If no treatment is selected, show all outcomes
            if (!treatmentId) {
                // Flatten all outcomes
                const allOutcomes = [];
                Object.values(window.outcomesByTreatment).forEach(outcomes => {
                    outcomes.forEach(outcome => {
                        // Avoid duplicates
                        if (!allOutcomes.find(o => o.id === outcome.id)) {
                            allOutcomes.push(outcome);
                        }
                    });
                });
                
                // Sort by name
                allOutcomes.sort((a, b) => a.name.localeCompare(b.name));
                
                // Add options
                allOutcomes.forEach(outcome => {
                    const option = document.createElement('option');
                    option.value = outcome.id;
                    option.textContent = outcome.name;
                    outcomeSelect.appendChild(option);
                });
            } else {
                // Show outcomes for selected treatment
                const outcomes = window.outcomesByTreatment[treatmentId] || [];
                
                if (outcomes.length > 0) {
                    outcomes.forEach(outcome => {
                        const option = document.createElement('option');
                        option.value = outcome.id;
                        option.textContent = outcome.name;
                        outcomeSelect.appendChild(option);
                    });
                } else {
                    // Add a "No outcomes" option if no outcomes are available
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No outcomes for this treatment';
                    option.disabled = true;
                    outcomeSelect.appendChild(option);
                }
            }
        }
        
        /**
         * Update department select options based on selected organization
         * @param {string} organizationId - Selected organization ID
         */
        function updateDepartmentSelectOptions(organizationId) {
            const departmentSelect = document.getElementById('departmentSelect');
            if (!departmentSelect) return;
            
            // Preserve the first option
            const firstOption = departmentSelect.options[0];
            
            // Clear existing options
            departmentSelect.innerHTML = '';
            
            // Add back the first option
            if (firstOption) {
                departmentSelect.appendChild(firstOption);
            }
            
            // If no organization is selected, disable department select
            if (!organizationId) {
                departmentSelect.disabled = true;
                return;
            }
            
            // Enable department select
            departmentSelect.disabled = false;
            
            // Load departments for the selected organization
            fetch(`/api/departments?organization_id=${organizationId}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        data.forEach(department => {
                            const option = document.createElement('option');
                            option.value = department.id;
                            option.textContent = department.name;
                            departmentSelect.appendChild(option);
                        });
                    } else {
                        // Add a "No departments" option if no departments are available
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No departments for this organization';
                        option.disabled = true;
                        departmentSelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Error loading departments:', error);
                    
                    // Add an error option
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Error loading departments';
                    option.disabled = true;
                    departmentSelect.appendChild(option);
                });
        }
        
        /**
         * Load price-outcome data
         */
        function loadPriceOutcomeData() {
            // Get filter values
            const treatmentId = document.getElementById('treatmentSelect')?.value || '';
            const outcomeId = document.getElementById('outcomeSelect')?.value || '';
            const organizationId = document.getElementById('organizationSelect')?.value || '';
            const priceMin = document.getElementById('priceRangeMin')?.value || '';
            const priceMax = document.getElementById('priceRangeMax')?.value || '';
            
            // Build query parameters
            const params = new URLSearchParams();
            if (treatmentId) params.append('treatment_id', treatmentId);
            if (outcomeId) params.append('outcome_id', outcomeId);
            if (organizationId) params.append('organization_id', organizationId);
            if (priceMin) params.append('price_min', priceMin);
            if (priceMax) params.append('price_max', priceMax);
            
            // Show loading state
            showPriceOutcomeLoading(true);
            
            // Fetch data from API
            fetch(`/analytics/price-outcome-data?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    // Update charts and tables
                    updatePriceOutcomeChart(data);
                    updateEfficiencyRanking(data);
                    generatePriceOutcomeInsights(data);
                    
                    // Hide loading state
                    showPriceOutcomeLoading(false);
                })
                .catch(error => {
                    console.error('Error loading price-outcome data:', error);
                    
                    // Show error state
                    showPriceOutcomeError();
                    
                    // Hide loading state
                    showPriceOutcomeLoading(false);
                });
        }
        
        /**
         * Show or hide price-outcome loading state
         * @param {boolean} isLoading - Whether loading state should be shown
         */
        function showPriceOutcomeLoading(isLoading) {
            // Chart loading
            const chartContainer = document.getElementById('priceOutcomeChart').parentElement;
            
            if (isLoading) {
                // Create loading overlay for chart
                createLoadingOverlay(chartContainer, 'Loading price-outcome data...');
            } else {
                // Remove any loading overlays
                const overlay = chartContainer.querySelector('.loading-overlay');
                if (overlay) {
                    overlay.remove();
                }
            }
        }
        
        /**
         * Show price-outcome error state
         */
        function showPriceOutcomeError() {
            // Show error in chart
            const chartContainer = document.getElementById('priceOutcomeChart').parentElement;
            chartContainer.innerHTML = `
                <div class="alert alert-danger m-3">
                    <i class="fas fa-exclamation-circle me-2"></i> 
                    Error loading price-outcome data. Please try again.
                </div>
            `;
            
            // Show error in ranking cards
            document.getElementById('rank1Card').innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-circle me-2"></i> 
                    Error loading ranking data.
                </div>
            `;
            
            document.getElementById('rank2Card').innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-circle me-2"></i> 
                    Error loading ranking data.
                </div>
            `;

            document.getElementById('rank3Card').innerHTML = `
            <div class="alert alert-danger mb-0">
                <i class="fas fa-exclamation-circle me-2"></i> 
                Error loading ranking data.
            </div>
        `;
        
        // Show error in insights
        document.getElementById('priceOutcomeInsights').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i> 
                Error generating insights. Please try again.
            </div>
        `;
    }
    
    /**
     * Update price-outcome chart with data
     * @param {Array} data - Price-outcome data
     */
    function updatePriceOutcomeChart(data) {
        const canvas = document.getElementById('priceOutcomeChart');
        if (!canvas) return;
        
        // Get current chart type
        const chartType = document.getElementById('chartTypeDropdown').textContent.trim().includes('Bubble') ? 'bubble' : 
                          document.getElementById('chartTypeDropdown').textContent.trim().includes('Bar') ? 'bar' : 'scatter';
        
        // Create datasets
        let datasets = [];
        
        if (data && data.length > 0) {
            // Group by outcome
            const outcomeGroups = {};
            
            data.forEach(item => {
                if (!outcomeGroups[item.outcome]) {
                    outcomeGroups[item.outcome] = [];
                }
                
                outcomeGroups[item.outcome].push(item);
            });
            
            // Create datasets for each outcome
            const colors = generateChartColors(Object.keys(outcomeGroups).length);
            
            let index = 0;
            for (const outcome in outcomeGroups) {
                const items = outcomeGroups[outcome];
                const color = colors[index];
                
                if (chartType === 'bubble') {
                    datasets.push({
                        label: outcome,
                        data: items.map(item => ({
                            x: item.cost,
                            y: item.measurement,
                            r: Math.sqrt(item.sample_size || 10) / 2, // Bubble size based on sample size
                            treatment: item.treatment,
                            outcome: item.outcome,
                            ratio: item.ratio,
                            organization: item.organization
                        })),
                        backgroundColor: color.replace('0.7', '0.5'),
                        borderColor: color.replace('0.7', '1'),
                        borderWidth: 1
                    });
                } else if (chartType === 'bar') {
                    datasets.push({
                        label: outcome,
                        data: items.map(item => item.measurement),
                        backgroundColor: color.replace('0.7', '0.7'),
                        borderColor: color.replace('0.7', '1'),
                        borderWidth: 1
                    });
                } else { // scatter
                    datasets.push({
                        label: outcome,
                        data: items.map(item => ({
                            x: item.cost,
                            y: item.measurement,
                            treatment: item.treatment,
                            outcome: item.outcome,
                            ratio: item.ratio,
                            organization: item.organization,
                            sample_size: item.sample_size
                        })),
                        backgroundColor: color.replace('0.7', '0.7'),
                        borderColor: color.replace('0.7', '1'),
                        borderWidth: 1,
                        pointRadius: 8,
                        pointHoverRadius: 10
                    });
                }
                
                index++;
            }
        }
        
        // Chart configuration
        const chartConfig = {
            type: chartType,
            data: {
                labels: chartType === 'bar' ? data.map(item => item.treatment) : [],
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: chartType === 'bar' ? 'Treatment' : 'Cost ($)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Outcome Measure'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const point = context.raw;
                                
                                if (chartType === 'bar') {
                                    return `${context.dataset.label}: ${context.raw}`;
                                }
                                
                                return [
                                    `Treatment: ${point.treatment}`,
                                    `Outcome: ${point.outcome}`,
                                    `Cost: $${point.x.toFixed(2)}`,
                                    `Value: ${point.y.toFixed(2)}`,
                                    `Ratio: ${point.ratio.toFixed(2)}`,
                                    `Organization: ${point.organization || 'N/A'}`,
                                    `Sample Size: ${point.sample_size || 'N/A'}`
                                ];
                            }
                        }
                    }
                }
            }
        };
        
        // Create or update chart
        if (window.priceOutcomeChart) {
            window.priceOutcomeChart.destroy();
        }
        
        window.priceOutcomeChart = new Chart(canvas, chartConfig);
    }
    
    /**
     * Update price-outcome chart type
     * @param {string} chartType - New chart type
     */
    function updatePriceOutcomeChartType(chartType) {
        // Get current chart
        if (!window.priceOutcomeChart) return;
        
        // Get current data
        const currentData = window.priceOutcomeChart.data;
        
        // Update chart type
        window.priceOutcomeChart.destroy();
        
        // Create new chart with updated type
        const canvas = document.getElementById('priceOutcomeChart');
        
        // Convert data format if needed
        let newData = {};
        
        if (chartType === 'bar') {
            // Extract labels (treatments) and reorganize data
            const treatments = [];
            const dataByOutcome = {};
            
            currentData.datasets.forEach(dataset => {
                const outcome = dataset.label;
                dataByOutcome[outcome] = [];
                
                dataset.data.forEach(point => {
                    if (!treatments.includes(point.treatment)) {
                        treatments.push(point.treatment);
                    }
                    
                    dataByOutcome[outcome].push({
                        treatment: point.treatment,
                        value: point.y
                    });
                });
            });
            
            // Create new datasets
            const newDatasets = [];
            
            for (const outcome in dataByOutcome) {
                const color = currentData.datasets.find(d => d.label === outcome).backgroundColor;
                
                newDatasets.push({
                    label: outcome,
                    data: treatments.map(treatment => {
                        const point = dataByOutcome[outcome].find(p => p.treatment === treatment);
                        return point ? point.value : null;
                    }),
                    backgroundColor: color,
                    borderColor: color.replace('0.7', '1'),
                    borderWidth: 1
                });
            }
            
            newData = {
                labels: treatments,
                datasets: newDatasets
            };
        } else {
            // Keep current data format
            newData = currentData;
        }
        
        // Create new chart
        window.priceOutcomeChart = new Chart(canvas, {
            type: chartType,
            data: newData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: chartType === 'bar' ? 'Treatment' : 'Cost ($)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Outcome Measure'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (chartType === 'bar') {
                                    return `${context.dataset.label}: ${context.raw}`;
                                }
                                
                                const point = context.raw;
                                return [
                                    `Treatment: ${point.treatment}`,
                                    `Outcome: ${point.outcome}`,
                                    `Cost: $${point.x.toFixed(2)}`,
                                    `Value: ${point.y.toFixed(2)}`,
                                    `Ratio: ${point.ratio.toFixed(2)}`,
                                    `Organization: ${point.organization || 'N/A'}`,
                                    `Sample Size: ${point.sample_size || 'N/A'}`
                                ];
                            }
                        }
                    }
                }
            }
        });
    }
    
    /**
     * Update efficiency ranking with data
     * @param {Array} data - Price-outcome data
     */
    function updateEfficiencyRanking(data) {
        if (!data || data.length === 0) {
            // No data
            document.getElementById('rank1Card').innerHTML = `
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i> 
                    No ranking data available.
                </div>
            `;
            
            document.getElementById('rank2Card').innerHTML = `
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i> 
                    No ranking data available.
                </div>
            `;
            
            document.getElementById('rank3Card').innerHTML = `
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i> 
                    No ranking data available.
                </div>
            `;
            
            // Clear table
            document.getElementById('efficiencyTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center">No data available</td>
                </tr>
            `;
            
            return;
        }
        
        // Sort data by efficiency ratio (lower is better)
        const sortedData = [...data].sort((a, b) => a.ratio - b.ratio);
        
        // Update ranking cards
        if (sortedData.length >= 1) {
            document.getElementById('rank1Card').innerHTML = createRankingCardContent(sortedData[0], 1);
        } else {
            document.getElementById('rank1Card').innerHTML = '<p class="text-muted mb-0">No data available</p>';
        }
        
        if (sortedData.length >= 2) {
            document.getElementById('rank2Card').innerHTML = createRankingCardContent(sortedData[1], 2);
        } else {
            document.getElementById('rank2Card').innerHTML = '<p class="text-muted mb-0">No data available</p>';
        }
        
        if (sortedData.length >= 3) {
            document.getElementById('rank3Card').innerHTML = createRankingCardContent(sortedData[2], 3);
        } else {
            document.getElementById('rank3Card').innerHTML = '<p class="text-muted mb-0">No data available</p>';
        }
        
        // Update efficiency table
        let tableHtml = '';
        
        sortedData.forEach((item, index) => {
            const rankClass = index === 0 ? 'bg-success text-white' : 
                              index === 1 ? 'bg-info text-white' : 
                              index === 2 ? 'bg-primary text-white' : '';
            
            tableHtml += `
                <tr>
                    <td class="${rankClass}">${index + 1}</td>
                    <td>${item.treatment}</td>
                    <td>${item.outcome}</td>
                    <td>${item.measurement.toFixed(2)}</td>
                    <td>$${item.cost.toFixed(2)}</td>
                    <td>${item.ratio.toFixed(2)}</td>
                    <td>${item.organization || 'N/A'}</td>
                </tr>
            `;
        });
        
        if (tableHtml) {
            document.getElementById('efficiencyTableBody').innerHTML = tableHtml;
        } else {
            document.getElementById('efficiencyTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center">No data available</td>
                </tr>
            `;
        }
    }
    
    /**
     * Create ranking card content
     * @param {Object} item - Ranking item
     * @param {number} rank - Rank number
     * @returns {string} Card content HTML
     */
    function createRankingCardContent(item, rank) {
        return `
            <div class="text-center mb-3">
                <h4>${item.treatment}</h4>
                <p class="text-muted">${item.outcome}</p>
            </div>
            <div class="row text-center">
                <div class="col-4">
                    <h5 class="text-success">$${item.cost.toFixed(2)}</h5>
                    <small class="text-muted">Cost</small>
                </div>
                <div class="col-4">
                    <h5 class="text-primary">${item.measurement.toFixed(2)}</h5>
                    <small class="text-muted">Outcome</small>
                </div>
                <div class="col-4">
                    <h5 class="text-danger">${item.ratio.toFixed(2)}</h5>
                    <small class="text-muted">Ratio</small>
                </div>
            </div>
            <p class="card-text mt-3 text-center">
                <small class="text-muted">
                    ${item.organization ? `Organization: ${item.organization}` : ''}
                    ${item.sample_size ? `<br>Sample Size: ${item.sample_size}` : ''}
                </small>
            </p>
        `;
    }
    
    /**
     * Generate price-outcome insights
     * @param {Array} data - Price-outcome data
     */
    function generatePriceOutcomeInsights(data) {
        const insightsContainer = document.getElementById('priceOutcomeInsights');
        if (!insightsContainer) return;
        
        if (!data || data.length === 0) {
            insightsContainer.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> 
                    No data available for insights. Please adjust your filters and try again.
                </div>
            `;
            return;
        }
        
        // Calculate basic statistics
        const avgCost = data.reduce((sum, item) => sum + item.cost, 0) / data.length;
        const avgOutcome = data.reduce((sum, item) => sum + item.measurement, 0) / data.length;
        const avgRatio = data.reduce((sum, item) => sum + item.ratio, 0) / data.length;
        
        // Get best and worst treatments
        const sortedByRatio = [...data].sort((a, b) => a.ratio - b.ratio);
        const best = sortedByRatio[0];
        const worst = sortedByRatio[sortedByRatio.length - 1];
        
        // Calculate potential savings
        const potentialSavings = (worst.cost - best.cost) * 100; // Assume 100 treatments
        
        // Generate insights
        let insightsHtml = `
            <div class="row mb-4">
                <div class="col-md-4 text-center mb-3 mb-md-0">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="text-primary">$${avgCost.toFixed(2)}</h3>
                            <p class="text-muted mb-0">Average Treatment Cost</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-center mb-3 mb-md-0">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="text-success">${avgOutcome.toFixed(2)}</h3>
                            <p class="text-muted mb-0">Average Outcome Score</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <div class="card h-100">
                        <div class="card-body">
                            <h3 class="text-info">${avgRatio.toFixed(2)}</h3>
                            <p class="text-muted mb-0">Average Cost-Effectiveness Ratio</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-primary">
                <h5><i class="fas fa-lightbulb me-2"></i> Key Insights</h5>
                <p>
                    The analysis identified ${best.treatment} as the most cost-effective treatment for ${best.outcome} 
                    with a cost-effectiveness ratio of ${best.ratio.toFixed(2)}.
                </p>
                <p>
                    Switching from ${worst.treatment} (ratio: ${worst.ratio.toFixed(2)}) to ${best.treatment} 
                    could potentially save approximately $${potentialSavings.toFixed(2)} per 100 treatments 
                    while maintaining similar or better outcomes.
                </p>
                <p>
                    The price disparity among treatments ranges from $${sortedByRatio[0].cost.toFixed(2)} to 
                    $${sortedByRatio[sortedByRatio.length-1].cost.toFixed(2)}, representing a 
                    ${(((sortedByRatio[sortedByRatio.length-1].cost - sortedByRatio[0].cost) / sortedByRatio[0].cost) * 100).toFixed(0)}% 
                    variation in treatment costs.
                </p>
            </div>
            
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Optimization Opportunities</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        <li class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">Switch to Most Cost-Effective Treatment</h5>
                                <span class="badge bg-success">High Impact</span>
                            </div>
                            <p class="mb-1">
                                Consider switching to ${best.treatment} where clinically appropriate. 
                                This treatment offers the best balance of cost and outcomes.
                            </p>
                        </li>
                        <li class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">Negotiate Lower Prices</h5>
                                <span class="badge bg-primary">Medium Impact</span>
                            </div>
                            <p class="mb-1">
                                Use the price disparity data to negotiate lower prices for higher-cost treatments.
                            </p>
                        </li>
                        <li class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">Monitor Outcome Measurements</h5>
                                <span class="badge bg-info">Ongoing</span>
                            </div>
                            <p class="mb-1">
                                Continue monitoring outcome measurements to ensure consistent quality across treatments.
                            </p>
                        </li>
                    </ul>
                </div>
            </div>
        `;
        
        insightsContainer.innerHTML = insightsHtml;
    }
    
    /**
     * Update price-outcome metrics
     */
    function updatePriceOutcomeMetrics() {
        // Get selected metric
        const selectedMetric = document.querySelector('input[name="efficiencyMeasure"]:checked').value;
        const thresholdValue = parseFloat(document.getElementById('thresholdValue').value) || 50000;
        
        // Reload price-outcome data with the new metric
        loadPriceOutcomeData();
        
        // Show toast notification
        showToast('Analysis metrics updated successfully', 'success');
    }
    
    /**
     * Generate price-outcome recommendations
     */
    function generatePriceOutcomeRecommendations() {
        // Show recommendations modal
        const modal = new bootstrap.Modal(document.getElementById('recommendationsModal'));
        modal.show();
        
        // Show loading state
        document.getElementById('recommendationsContent').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Generating recommendations...</p>
            </div>
        `;
        
        // Get current filters
        const treatmentId = document.getElementById('treatmentSelect')?.value || '';
        const outcomeId = document.getElementById('outcomeSelect')?.value || '';
        const organizationId = document.getElementById('organizationSelect')?.value || '';
        
        // Build query parameters
        const params = new URLSearchParams();
        if (treatmentId) params.append('treatment_id', treatmentId);
        if (outcomeId) params.append('outcome_id', outcomeId);
        if (organizationId) params.append('organization_id', organizationId);
        
        // Generate recommendations
        fetch(`/analytics/generate-recommendations?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success state
                    document.getElementById('recommendationsContent').innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i> 
                            Successfully generated ${data.count} new recommendations!
                        </div>
                        <div class="recommendations-list mt-3">
                            <!-- Recommendations would be dynamically generated in a real application -->
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Optimize Treatment Selection</h5>
                                    <p class="card-text">
                                        Based on cost-effectiveness analysis, consider optimizing treatment selection
                                        by prioritizing treatments with better cost-to-outcome ratios.
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-success">High Impact</span>
                                        <span class="text-muted">Estimated Savings: $${(Math.random() * 10000 + 5000).toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Negotiate Volume Discounts</h5>
                                    <p class="card-text">
                                        Use price disparity data to negotiate better prices with suppliers based on
                                        price benchmarks and volume commitments.
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-primary">Medium Impact</span>
                                        <span class="text-muted">Estimated Savings: $${(Math.random() * 5000 + 2000).toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Standardize Outcome Measurements</h5>
                                    <p class="card-text">
                                        Implement standardized outcome measurement protocols to improve data quality
                                        and comparability across treatments and organizations.
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-info">Process Improvement</span>
                                        <span class="text-muted">Long-term benefit</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Show error state
                    document.getElementById('recommendationsContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i> 
                            Error generating recommendations. Please try again.
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error generating recommendations:', error);
                
                // Show error state
                document.getElementById('recommendationsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i> 
                        Error generating recommendations. Please try again.
                    </div>
                `;
            });
    }
    
    /**
     * Save recommendations
     */
    function saveRecommendations() {
        // In a real application, this would save the recommendations to the database
        showToast('Recommendations saved successfully', 'success');
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('recommendationsModal'));
        modal.hide();
    }
    
    /**
     * Load resource data
     */
    function loadResourceData() {
        // This function would load resource allocation data from the API
        // For the sake of brevity, implementation details are omitted
    }
    
    /**
     * Load regional data
     */
    function loadRegionalData() {
        // This function would load regional price disparity data from the API
        // For the sake of brevity, implementation details are omitted
    }
    
    /**
     * Load trend data
     */
    function loadTrendData() {
        // This function would load trend analysis data from the API
        // For the sake of brevity, implementation details are omitted
    }
    
    /**
     * Update resource analysis
     */
    function updateResourceAnalysis() {
        // This function would update resource analysis parameters
        // For the sake of brevity, implementation details are omitted
    }
    
    /**
     * Update trend analysis
     */
    function updateTrendAnalysis() {
        // This function would update trend analysis options
        // For the sake of brevity, implementation details are omitted
    }
    
    /**
     * Update resource chart type
     * @param {string} chartType - New chart type
     */
    function updateResourceChartType(chartType) {
        // This function would update resource chart type
        // For the sake of brevity, implementation details are omitted
    }
    
    /**
     * Update regional chart type
     * @param {string} chartType - New chart type
     */
    function updateRegionalChartType(chartType) {
        // This function would update regional chart type
        // For the sake of brevity, implementation details are omitted
    }
    
    /**
     * Update trend chart type
     * @param {string} chartType - New chart type
     */
    function updateTrendChartType(chartType) {
        // This function would update trend chart type
        // For the sake of brevity, implementation details are omitted
    }
    
    /**
     * Generate resource recommendations
     */
    function generateResourceRecommendations() {
        // This function would generate resource optimization recommendations
        // For the sake of brevity, implementation details are omitted
    }
    
    /**
     * Generate waste report
     */
    function generateWasteReport() {
        // This function would generate a waste identification report
        // For the sake of brevity, implementation details are omitted
    }
    
    /**
     * Generate regional report
     */
    function generateRegionalReport() {
        // This function would generate a regional price disparity report
        // For the sake of brevity, implementation details are omitted
    }
    
    /**
     * Generate trend report
     */
    function generateTrendReport() {
        // This function would generate a trend analysis report
        // For the sake of brevity, implementation details are omitted
    }
    
    /**
     * Filter analysis by type
     * @param {string} type - Analysis type to filter by
     */
    function filterAnalysisByType(type) {
        // This function would filter the displayed analyses by type
        // For the sake of brevity, implementation details are omitted
    }
    
    /**
     * Show toast notification
     * @param {string} message - Toast message
     * @param {string} type - Toast type (success, info, warning, error)
     */
    function showToast(message, type) {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type}`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        // Create toast content
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        // Add toast to container
        toastContainer.appendChild(toast);
        
        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 3000
        });
        bsToast.show();
    }
</script>
{% endblock %}